<section
  class="product-compare section {% if section.settings.color_scheme == 'surface' %}section--surface{% elsif section.settings.color_scheme == 'dark' %}section--dark{% endif %}"
  style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;"
  data-section-id="{{ section.id }}"
  data-product-compare
>
  <div class="container">
    {% if section.settings.heading != blank or section.settings.subheading != blank %}
      <div class="product-compare__header">
        {% if section.settings.heading != blank %}
          <h2 class="product-compare__heading" style="{% render 'heading-size-vars', desktop: section.settings.heading_size, mobile: section.settings.heading_size_mobile %}">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.subheading != blank %}
          <p class="product-compare__subheading">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}

    <button class="product-compare__toggle-btn button button--outline" data-compare-toggle>
      {{ section.settings.button_text }}
    </button>

    <div class="product-compare__panel" data-compare-panel style="display: none;">
      <div class="product-compare__grid">
        {%- for side in (1..2) -%}
          {%- assign side_label = 'left' -%}
          {%- if side == 2 -%}{%- assign side_label = 'right' -%}{%- endif -%}
          <div class="product-compare__column">
            <select class="product-compare__select" data-compare-select="{{ side_label }}">
              <option value="">{{ section.settings.select_placeholder }}</option>
              {%- for block in section.blocks -%}
                {%- if block.settings.product != blank -%}
                  <option value="{{ forloop.index0 }}">{{ block.settings.product.title }}</option>
                {%- elsif block.settings.product_name != blank -%}
                  <option value="{{ forloop.index0 }}">{{ block.settings.product_name }}</option>
                {%- endif -%}
              {%- endfor -%}
            </select>

            <div class="product-compare__display" data-compare-display="{{ side_label }}" style="display: none;">
              <img
                class="product-compare__image"
                data-compare-img="{{ side_label }}"
                src=""
                alt=""
                loading="lazy"
              >
              <h3 class="product-compare__name" data-compare-name="{{ side_label }}"></h3>
              <p class="product-compare__price" data-compare-price="{{ side_label }}"></p>
              <a
                class="product-compare__shop-link button button--primary"
                data-compare-link="{{ side_label }}"
                href="#"
              >
                {{ section.settings.shop_link_text }}
              </a>

              <h4 class="product-compare__summary-heading">{{ section.settings.summary_heading }}</h4>

              <table class="product-compare__specs">
                <tbody data-compare-specs="{{ side_label }}">
                </tbody>
              </table>
            </div>
          </div>
        {%- endfor -%}
      </div>

      <button class="product-compare__close" data-compare-close>{{ section.settings.close_text }}</button>
    </div>
  </div>

  <script type="application/json" data-compare-products>
    [
      {%- for block in section.blocks -%}
        {%- assign cp_product = block.settings.product -%}
        {%- if cp_product != blank -%}
          {%- assign cp_name = cp_product.title -%}
          {%- assign cp_url = cp_product.url -%}
          {%- if cp_product.featured_image -%}
            {%- assign cp_image = cp_product.featured_image | image_url: width: 800 -%}
          {%- elsif block.settings.product_image != blank -%}
            {%- assign cp_image = block.settings.product_image | image_url: width: 800 -%}
          {%- else -%}
            {%- assign cp_image = '' -%}
          {%- endif -%}
        {%- else -%}
          {%- assign cp_name = block.settings.product_name -%}
          {%- assign cp_url = block.settings.product_url | default: '#' -%}
          {%- if block.settings.product_image != blank -%}
            {%- assign cp_image = block.settings.product_image | image_url: width: 800 -%}
          {%- else -%}
            {%- assign cp_image = '' -%}
          {%- endif -%}
        {%- endif -%}
        {
          "name": {{ cp_name | json }},
          "image": {{ cp_image | json }},
          "url": {{ cp_url | json }},
          "price": {{ cp_product.price | default: 0 | money | json }},
          "specs": {
            {%- comment -%} Auto-read from product metafields; manual block settings override {%- endcomment -%}
            {%- if cp_product != blank -%}
              {%- assign cp_capacity = block.settings.spec_design | default: cp_product.metafields.custom.capacity -%}
              {%- assign cp_size = cp_product.metafields.custom.size -%}
              {%- assign cp_inside_dia = cp_product.metafields.custom.inside_diameter -%}
              {%- assign cp_outside_dia = cp_product.metafields.custom.outside_diameter -%}
              {%- if cp_inside_dia != blank and cp_outside_dia != blank -%}
                {%- assign cp_auto_dimensions = 'Ã˜' | append: cp_inside_dia | append: '/' | append: cp_outside_dia | append: ' cm' -%}
              {%- else -%}
                {%- assign cp_auto_dimensions = '' -%}
              {%- endif -%}
              {%- assign cp_ext_material = cp_product.metafields.custom.exterior_material -%}
              {%- assign cp_fiberglass = cp_product.metafields.custom.fiberglass_type -%}
              {%- assign cp_liner = cp_product.metafields.custom.liner_collection -%}
              {%- assign cp_hydro = cp_product.metafields.custom.hydro_massage -%}
              {%- assign cp_air = cp_product.metafields.custom.air_system -%}
              {%- assign cp_led = cp_product.metafields.custom.led_lighting -%}
              {%- assign cp_pillows = cp_product.metafields.custom.head_pillows -%}
              {%- assign cp_heating = cp_product.metafields.custom.oven_description -%}
              {%- assign cp_oven_type = cp_product.metafields.custom.oven_type -%}
            {%- else -%}
              {%- assign cp_capacity = '' -%}
              {%- assign cp_size = '' -%}
              {%- assign cp_auto_dimensions = '' -%}
              {%- assign cp_ext_material = '' -%}
              {%- assign cp_fiberglass = '' -%}
              {%- assign cp_liner = '' -%}
              {%- assign cp_hydro = '' -%}
              {%- assign cp_air = '' -%}
              {%- assign cp_led = '' -%}
              {%- assign cp_pillows = '' -%}
              {%- assign cp_heating = '' -%}
              {%- assign cp_oven_type = '' -%}
            {%- endif -%}
            "Capacity": {{ block.settings.spec_design | default: cp_capacity | json }},
            "Size": {{ cp_size | json }},
            "Dimensions": {{ block.settings.spec_dimensions | default: cp_auto_dimensions | json }},
            "Exterior material": {{ block.settings.spec_materials | default: cp_ext_material | json }},
            "Fiberglass type": {{ cp_fiberglass | json }},
            "Liner collection": {{ cp_liner | json }},
            "Hydro massage": {{ cp_hydro | json }},
            "Air system": {{ cp_air | json }},
            "LED lighting": {{ cp_led | json }},
            "Head pillows": {{ cp_pillows | json }},
            "Heating system": {{ block.settings.spec_heater | default: cp_heating | json }},
            "Oven type": {{ cp_oven_type | json }},
            "Access": {{ block.settings.spec_access | json }},
            "Indoor/outdoor use": {{ block.settings.spec_indoor_outdoor | json }},
            "Weatherproof": {{ block.settings.spec_weatherproof | json }},
            "Cover": {{ block.settings.spec_cover | json }},
            "Filter": {{ block.settings.spec_filter | json }},
            "Micron filter": {{ block.settings.spec_micron_filter | json }},
            "Warranty": {{ block.settings.spec_warranty | json }},
            "Portable": {{ block.settings.spec_portable | json }},
            "Commercial use": {{ block.settings.spec_commercial | json }},
            "Wifi connection": {{ block.settings.spec_wifi | json }},
            "Filter use duration": {{ block.settings.spec_filter_duration | json }},
            "Drainage valve": {{ block.settings.spec_drainage_valve | json }},
            "Automatic drainage": {{ block.settings.spec_auto_drainage | json }},
            "Overflow tank": {{ block.settings.spec_overflow_tank | json }},
            "Setup time": {{ block.settings.spec_setup_time | json }},
            "Engine cover": {{ block.settings.spec_engine_cover | json }},
            "Control features": {{ block.settings.spec_control | json }},
            "What's included": {{ block.settings.spec_included | json }},
            "Phone holder": {{ block.settings.spec_phone_holder | json }},
            "Stairs add-on": {{ block.settings.spec_stairs_addon | json }},
            "Water refill cycle": {{ block.settings.spec_water_refill | json }},
            "Cooling engine capacity": {{ block.settings.spec_cooling_capacity | json }},
            "Power consumption": {{ block.settings.spec_power_consumption | json }},
            "Power supply": {{ block.settings.spec_power_supply | json }},
            "Operating air temp range": {{ block.settings.spec_temp_range | json }},
            "Refrigerant": {{ block.settings.spec_refrigerant | json }},
            "Ozone output": {{ block.settings.spec_ozone | json }},
            "Water pump flow rate": {{ block.settings.spec_pump_flow | json }},
            "Noise level": {{ block.settings.spec_noise | json }},
            "Max power input": {{ block.settings.spec_max_power | json }},
            "Max current": {{ block.settings.spec_max_current | json }},
            "Advised water flow": {{ block.settings.spec_water_flow | json }},
            "Water pressure drop": {{ block.settings.spec_pressure_drop | json }},
            "Volume": {{ block.settings.spec_volume | json }},
            "Weight empty": {{ block.settings.spec_weight_empty | json }},
            "Weight full": {{ block.settings.spec_weight_full | json }},
            "Weight packaging": {{ block.settings.spec_weight_packaging | json }},
            "UV light": {{ block.settings.spec_uv_light | json }},
            "Frost resistance": {{ block.settings.spec_frost_resistance | json }}
          }
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ]
  </script>
</section>

<script>
  (function () {
    var section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;

    var toggleBtn = section.querySelector('[data-compare-toggle]');
    var panel = section.querySelector('[data-compare-panel]');
    var closeBtn = section.querySelector('[data-compare-close]');
    var selectLeft = section.querySelector('[data-compare-select="left"]');
    var selectRight = section.querySelector('[data-compare-select="right"]');
    var dataEl = section.querySelector('[data-compare-products]');

    if (!dataEl) return;

    var products = [];
    try {
      products = JSON.parse(dataEl.textContent);
    } catch (e) {
      console.warn('Product compare: failed to parse product data', e);
      return;
    }

    var defaultButtonText = toggleBtn ? toggleBtn.textContent.trim() : 'Compare models';
    var closeText = closeBtn ? closeBtn.textContent.trim() : 'Close compare models';
    var isOpen = false;

    function togglePanel() {
      isOpen = !isOpen;
      panel.style.display = isOpen ? 'block' : 'none';
      toggleBtn.textContent = isOpen ? closeText : defaultButtonText;
    }

    function closePanel() {
      isOpen = false;
      panel.style.display = 'none';
      toggleBtn.textContent = defaultButtonText;
    }

    function updateDisplay(side, index) {
      var display = section.querySelector('[data-compare-display="' + side + '"]');
      var img = section.querySelector('[data-compare-img="' + side + '"]');
      var name = section.querySelector('[data-compare-name="' + side + '"]');
      var price = section.querySelector('[data-compare-price="' + side + '"]');
      var link = section.querySelector('[data-compare-link="' + side + '"]');
      var specsBody = section.querySelector('[data-compare-specs="' + side + '"]');

      if (index === '' || index === null || index === undefined) {
        display.style.display = 'none';
        return;
      }

      var product = products[parseInt(index, 10)];
      if (!product) {
        display.style.display = 'none';
        return;
      }

      if (product.image) {
        img.src = product.image;
        img.alt = product.name;
        img.style.display = 'block';
      } else {
        img.src = '';
        img.alt = '';
        img.style.display = 'none';
      }

      name.textContent = product.name;
      if (price) price.textContent = product.price || '';
      link.href = product.url || '#';

      var rows = '';
      var specs = product.specs;
      for (var key in specs) {
        if (specs.hasOwnProperty(key) && specs[key] && specs[key] !== '') {
          rows += '<tr><th>' + key + '</th><td>' + specs[key] + '</td></tr>';
        }
      }
      specsBody.innerHTML = rows;

      display.style.display = 'block';
    }

    if (toggleBtn) {
      toggleBtn.addEventListener('click', togglePanel);
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', closePanel);
    }

    if (selectLeft) {
      selectLeft.addEventListener('change', function () {
        updateDisplay('left', this.value);
      });
    }

    if (selectRight) {
      selectRight.addEventListener('change', function () {
        updateDisplay('right', this.value);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Product Compare",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Which bath suits you?"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Compare models"
    },
    {
      "type": "text",
      "id": "select_placeholder",
      "label": "Dropdown placeholder",
      "default": "Select a model..."
    },
    {
      "type": "text",
      "id": "shop_link_text",
      "label": "Shop link text",
      "default": "Shop now"
    },
    {
      "type": "text",
      "id": "summary_heading",
      "label": "Summary heading",
      "default": "Summary"
    },
    {
      "type": "text",
      "id": "close_text",
      "label": "Close button text",
      "default": "Close compare models"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "heading_size_mobile",
      "label": "Heading size (mobile)",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "surface", "label": "Surface" },
        { "value": "dark", "label": "Dark" }
      ],
      "default": "default"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 40
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Select a product from your store. Name, image, and URL are pulled automatically."
        },
        { "type": "header", "content": "Manual overrides (used if no product selected)" },
        {
          "type": "text",
          "id": "product_name",
          "label": "Product name (fallback)"
        },
        {
          "type": "image_picker",
          "id": "product_image",
          "label": "Product image (override)"
        },
        {
          "type": "url",
          "id": "product_url",
          "label": "Product URL (fallback)"
        },
        { "type": "header", "content": "Specifications" },
        {
          "type": "text",
          "id": "spec_design",
          "label": "Design"
        },
        {
          "type": "text",
          "id": "spec_access",
          "label": "Access"
        },
        {
          "type": "text",
          "id": "spec_heater",
          "label": "Heater"
        },
        {
          "type": "text",
          "id": "spec_indoor_outdoor",
          "label": "Indoor/outdoor use"
        },
        {
          "type": "text",
          "id": "spec_weatherproof",
          "label": "Weatherproof"
        },
        {
          "type": "text",
          "id": "spec_materials",
          "label": "Materials"
        },
        {
          "type": "text",
          "id": "spec_cover",
          "label": "Cover"
        },
        {
          "type": "text",
          "id": "spec_filter",
          "label": "Filter"
        },
        {
          "type": "text",
          "id": "spec_micron_filter",
          "label": "Micron filter"
        },
        {
          "type": "text",
          "id": "spec_warranty",
          "label": "Warranty"
        },
        {
          "type": "text",
          "id": "spec_portable",
          "label": "Portable"
        },
        {
          "type": "text",
          "id": "spec_commercial",
          "label": "Commercial use"
        },
        {
          "type": "text",
          "id": "spec_wifi",
          "label": "Wifi connection"
        },
        {
          "type": "text",
          "id": "spec_filter_duration",
          "label": "Filter use duration"
        },
        {
          "type": "text",
          "id": "spec_drainage_valve",
          "label": "Drainage valve"
        },
        {
          "type": "text",
          "id": "spec_auto_drainage",
          "label": "Automatic drainage"
        },
        {
          "type": "text",
          "id": "spec_overflow_tank",
          "label": "Overflow tank"
        },
        {
          "type": "text",
          "id": "spec_setup_time",
          "label": "Setup time"
        },
        {
          "type": "text",
          "id": "spec_engine_cover",
          "label": "Engine cover"
        },
        {
          "type": "text",
          "id": "spec_control",
          "label": "Control features"
        },
        {
          "type": "text",
          "id": "spec_included",
          "label": "What's included"
        },
        {
          "type": "text",
          "id": "spec_phone_holder",
          "label": "Phone holder"
        },
        {
          "type": "text",
          "id": "spec_stairs_addon",
          "label": "Stairs add-on"
        },
        {
          "type": "text",
          "id": "spec_water_refill",
          "label": "Water refill cycle"
        },
        {
          "type": "text",
          "id": "spec_cooling_capacity",
          "label": "Cooling engine capacity"
        },
        {
          "type": "text",
          "id": "spec_power_consumption",
          "label": "Power consumption"
        },
        {
          "type": "text",
          "id": "spec_power_supply",
          "label": "Power supply"
        },
        {
          "type": "text",
          "id": "spec_temp_range",
          "label": "Operating air temp range"
        },
        {
          "type": "text",
          "id": "spec_refrigerant",
          "label": "Refrigerant"
        },
        {
          "type": "text",
          "id": "spec_ozone",
          "label": "Ozone output"
        },
        {
          "type": "text",
          "id": "spec_pump_flow",
          "label": "Water pump flow rate"
        },
        {
          "type": "text",
          "id": "spec_noise",
          "label": "Noise level"
        },
        {
          "type": "text",
          "id": "spec_max_power",
          "label": "Max power input"
        },
        {
          "type": "text",
          "id": "spec_max_current",
          "label": "Max current"
        },
        {
          "type": "text",
          "id": "spec_water_flow",
          "label": "Advised water flow"
        },
        {
          "type": "text",
          "id": "spec_pressure_drop",
          "label": "Water pressure drop"
        },
        { "type": "header", "content": "Physical specs" },
        {
          "type": "text",
          "id": "spec_dimensions",
          "label": "Dimensions"
        },
        {
          "type": "text",
          "id": "spec_volume",
          "label": "Volume"
        },
        {
          "type": "text",
          "id": "spec_weight_empty",
          "label": "Weight empty"
        },
        {
          "type": "text",
          "id": "spec_weight_full",
          "label": "Weight full"
        },
        {
          "type": "text",
          "id": "spec_weight_packaging",
          "label": "Weight packaging"
        },
        {
          "type": "text",
          "id": "spec_uv_light",
          "label": "UV light"
        },
        {
          "type": "text",
          "id": "spec_frost_resistance",
          "label": "Frost resistance"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Compare",
      "settings": {
        "heading": "Which bath suits you?",
        "subheading": "Compare models side by side to easily see the differences in size, features, and functions."
      },
      "blocks": []
    }
  ]
}
{% endschema %}