{%- comment -%}
  Nordic Elite Hot Tub Configurator v2
  Dynamic 15-step configurator reading from Shopify products & collections.
  All product data is serialized to JSON and rendered by configurator.js.
{%- endcomment -%}

{%- assign cfg_id = section.id | replace: '_', '' | downcase -%}
{%- assign tag_name = 'hot-tub-cfg-' | append: cfg_id -%}


{% style %}
  .cfg-{{ cfg_id }} { background-color: {{ section.settings.background_color }}; }
  .cfg-{{ cfg_id }} .cfg__wrap { padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px; }
{% endstyle %}

{%- comment -%} ═══════════ HTML ═══════════ {%- endcomment -%}
<{{ tag_name }} class="cfg cfg-{{ cfg_id }}" data-cfg-tag="{{ tag_name }}">
  <div class="cfg__wrap">

    {%- comment -%} ── LEFT: Image panel ── {%- endcomment -%}
    <div class="cfg__images">
      <div class="cfg__main-wrap">
        <div class="cfg__loader" data-img-loading style="display:none;"><div class="cfg__spinner"></div></div>
        <div class="cfg__placeholder" data-main-placeholder>
          {%- if section.settings.default_image != blank -%}
            <img src="{{ section.settings.default_image | image_url: width: 1200 }}" alt="Nordic Elite hot tub" style="width:100%;height:100%;object-fit:cover;" loading="eager">
          {%- else -%}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
            <span>Select a model to preview your hot tub</span>
          {%- endif -%}
        </div>
        <img src="" alt="Hot tub preview" class="cfg-main-image" data-main-image loading="eager" style="display:none;">
      </div>
      <div class="cfg__gallery" data-gallery></div>
    </div>

    {%- comment -%} ── RIGHT: Config steps ── {%- endcomment -%}
    <div class="cfg__steps" data-steps>

      {%- for i in (1..15) -%}
        {%- assign locked = '' -%}
        {%- if i > 1 -%}{%- assign locked = ' cfg-step--locked' -%}{%- endif -%}
        {%- assign step_hidden = false -%}

        {%- case i -%}
          {%- when 1 -%}{%- assign s_title = 'Your Hot Tub' -%}{%- assign s_sub = 'Choose model and size.' -%}
          {%- when 2 -%}{%- assign s_title = 'Fiberglass Liner' -%}{%- assign s_sub = 'Select collection & color.' -%}
          {%- when 3 -%}{%- assign s_title = 'Hot Tub Insulation' -%}{%- assign s_sub = 'Additional insulation layer.' -%}
          {%- when 4 -%}{%- assign s_title = 'Heating System' -%}{%- assign s_sub = 'External or internal oven.' -%}
          {%- when 5 -%}{%- assign s_title = 'Exterior Panel' -%}{%- assign s_sub = 'Pick your wood finish.' -%}
          {%- when 6 -%}{%- assign s_title = 'Hydro Massage' -%}{%- assign s_sub = 'Select system & nozzle count.' -%}
          {%- when 7 -%}{%- assign s_title = 'Air System' -%}{%- assign s_sub = 'Select system & nozzle count.' -%}
          {%- when 8 -%}{%- assign s_title = 'Filter System' -%}{%- assign s_sub = 'Filtration options.' -%}
          {%- when 9 -%}{%- assign s_title = 'LED Lighting' -%}{%- assign s_sub = 'Choose lamp size & quantity.' -%}
          {%- when 10 -%}{%- assign s_title = 'Thermometer' -%}{%- assign s_sub = 'Temperature monitoring.' -%}
          {%- when 11 -%}{%- assign s_title = 'Stairs' -%}{%- assign s_sub = 'Matching exterior material.' -%}
          {%- when 12 -%}{%- assign s_title = 'Hot Tub Head Pillows' -%}{%- assign s_sub = 'Comfort accessories.' -%}
          {%- when 13 -%}{%- assign s_title = 'Cover' -%}{%- assign s_sub = 'Protect your hot tub.' -%}
          {%- when 14 -%}{%- assign s_title = 'Control Installation' -%}{%- assign s_sub = 'Mark installation locations.' -%}
          {%- when 15 -%}{%- assign s_title = 'Heater Connection Type' -%}{%- assign s_sub = 'Connection angle.' -%}
        {%- endcase -%}

        <div class="cfg-step{{ locked }}" data-step="{{ i }}" role="group" aria-labelledby="cfg-step-title-{{ i }}" {% if i > 1 %}aria-disabled="true"{% else %}aria-disabled="false"{% endif %}>
          <div class="cfg-step__header">
            <span class="cfg-step__badge" aria-hidden="true">{{ i }}</span>
            <h3 class="cfg-step__title" id="cfg-step-title-{{ i }}">{{ s_title }}</h3>
          </div>
          <p class="cfg-step__subtitle">{{ s_sub }}</p>
          <div class="cfg-step__body" {% if i > 1 %}inert{% endif %}>
            {%- comment -%} Content rendered by JS from JSON data {%- endcomment -%}
          </div>
        </div>

        {%- unless i == 15 -%}<div class="cfg-divider"></div>{%- endunless -%}
      {%- endfor -%}

      {%- comment -%} ── Summary ── {%- endcomment -%}
      <div class="cfg-step" data-step="summary">
        <div class="cfg-step__header">
          <span class="cfg-step__badge" aria-hidden="true">✓</span>
          <h3 class="cfg-step__title">Your Configuration</h3>
        </div>
        <ul data-summary-list style="list-style: disc; padding-left: 20px;"></ul>
      </div>

      {%- comment -%} ── Price + CTA ── {%- endcomment -%}
      <div class="cfg__bottom">
        <div class="cfg__total" data-total-price aria-live="polite" style="visibility:hidden;">—</div>
        <p class="cfg__error" data-cart-error></p>
        <button class="cfg__cta" data-add-to-cart disabled>Select a model to start</button>
        {%- if section.settings.specs_page != blank -%}
          <a href="{{ section.settings.specs_page }}" class="cfg__specs-link">View full specifications</a>
        {%- endif -%}
      </div>
    </div>
  </div>

  {%- comment -%} ═══════════ PRODUCT DATA (JSON) ═══════════ {%- endcomment -%}
  <script type="application/json" data-configurator-products>
  {
    "base": [
      {%- assign _base_sep = false -%}
      {%- if section.settings.base_classic_collection != blank -%}
        {%- assign col = section.settings.base_classic_collection -%}
        {%- if _base_sep -%},{%- endif -%}
        {
          "key": "classic",
          "title": {{ col.title | json }},
          "image": {% if col.image %}{{ col.image | image_url: width: 600 | json }}{% elsif col.products.first.featured_image %}{{ col.products.first.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          "body": {{ col.description | strip_html | truncate: 200 | json }},
          {%- assign _bp_min = 999999999 -%}{%- for product in col.products -%}{%- if product.price < _bp_min -%}{%- assign _bp_min = product.price -%}{%- endif -%}{%- endfor -%}
          "price": {{ _bp_min | default: 0 }},
          "products": [
            {%- for product in col.products limit: 10 -%}
              {%- unless forloop.first -%},{%- endunless -%}
              {% render 'configurator-product-json', product: product %}
            {%- endfor -%}
          ]
        }
        {%- assign _base_sep = true -%}
      {%- endif -%}
      {%- if section.settings.base_premium_collection != blank -%}
        {%- assign col = section.settings.base_premium_collection -%}
        {%- if _base_sep -%},{%- endif -%}
        {
          "key": "premium",
          "title": {{ col.title | json }},
          "image": {% if col.image %}{{ col.image | image_url: width: 600 | json }}{% elsif col.products.first.featured_image %}{{ col.products.first.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          "body": {{ col.description | strip_html | truncate: 200 | json }},
          {%- assign _bp_min = 999999999 -%}{%- for product in col.products -%}{%- if product.price < _bp_min -%}{%- assign _bp_min = product.price -%}{%- endif -%}{%- endfor -%}
          "price": {{ _bp_min | default: 0 }},
          "products": [
            {%- for product in col.products limit: 10 -%}
              {%- unless forloop.first -%},{%- endunless -%}
              {% render 'configurator-product-json', product: product %}
            {%- endfor -%}
          ]
        }
        {%- assign _base_sep = true -%}
      {%- endif -%}
      {%- if section.settings.base_signature_collection != blank -%}
        {%- assign col = section.settings.base_signature_collection -%}
        {%- if _base_sep -%},{%- endif -%}
        {
          "key": "signature",
          "title": {{ col.title | json }},
          "image": {% if col.image %}{{ col.image | image_url: width: 600 | json }}{% elsif col.products.first.featured_image %}{{ col.products.first.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          "body": {{ col.description | strip_html | truncate: 200 | json }},
          {%- assign _bp_min = 999999999 -%}{%- for product in col.products -%}{%- if product.price < _bp_min -%}{%- assign _bp_min = product.price -%}{%- endif -%}{%- endfor -%}
          "price": {{ _bp_min | default: 0 }},
          "products": [
            {%- for product in col.products limit: 10 -%}
              {%- unless forloop.first -%},{%- endunless -%}
              {% render 'configurator-product-json', product: product %}
            {%- endfor -%}
          ]
        }
        {%- assign _base_sep = true -%}
      {%- endif -%}
    ],

    {%- comment -%} ── Collections → JSON arrays ── {%- endcomment -%}

    {%- comment -%} Liners (Step 2) {%- endcomment -%}
    "liners": [
      {%- if section.settings.liners_collection != blank -%}
        {%- for product in section.settings.liners_collection.products limit: 20 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Insulation (Step 3) — single product stored as array {%- endcomment -%}
    "insulations": [
      {%- if section.settings.insulation_product != blank -%}
        {%- assign product = section.settings.insulation_product -%}
        {% render 'configurator-product-json', product: product %}
      {%- endif -%}
    ],

    "oven_addons": [
      {%- if section.settings.oven_addons_collection != blank -%}
        {%- for product in section.settings.oven_addons_collection.products limit: 10 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Exteriors (Step 5) {%- endcomment -%}
    "exteriors": [
      {%- if section.settings.exteriors_collection != blank -%}
        {%- for product in section.settings.exteriors_collection.products limit: 20 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Hydro Massage (Step 6) {%- endcomment -%}
    "hydro": [
      {%- if section.settings.hydro_collection != blank -%}
        {%- for product in section.settings.hydro_collection.products limit: 10 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Air System (Step 7) {%- endcomment -%}
    "air": [
      {%- if section.settings.air_collection != blank -%}
        {%- for product in section.settings.air_collection.products limit: 10 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Filter System (Step 8) {%- endcomment -%}
    "filters": [
      {%- if section.settings.filters_collection != blank -%}
        {%- for product in section.settings.filters_collection.products limit: 10 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} LED Lighting (Step 9) {%- endcomment -%}
    "leds": [
      {%- if section.settings.leds_collection != blank -%}
        {%- for product in section.settings.leds_collection.products limit: 10 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Thermometer (Step 10) {%- endcomment -%}
    "thermometers": [
      {%- if section.settings.thermometers_collection != blank -%}
        {%- for product in section.settings.thermometers_collection.products limit: 10 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Stairs (Step 11) {%- endcomment -%}
    "stairs": [
      {%- if section.settings.stairs_product != blank -%}
        {%- assign product = section.settings.stairs_product -%}
        {% render 'configurator-product-json', product: product %}
      {%- endif -%}
    ],

    {%- comment -%} Pillows (Step 12) {%- endcomment -%}
    "pillows": [
      {%- if section.settings.pillows_product != blank -%}
        {%- assign product = section.settings.pillows_product -%}
        {% render 'configurator-product-json', product: product %}
      {%- endif -%}
    ],

    {%- comment -%} Covers (Step 13) {%- endcomment -%}
    "covers": [
      {%- if section.settings.covers_collection != blank -%}
        {%- for product in section.settings.covers_collection.products limit: 10 -%}
          {%- unless forloop.first -%},{%- endunless -%}
          {% render 'configurator-product-json', product: product %}
        {%- endfor -%}
      {%- endif -%}
    ],

    {%- comment -%} Heater 90° (Step 15) {%- endcomment -%}
    "heater_90": {%- if section.settings.heater_90_product != blank -%}
      {%- assign product = section.settings.heater_90_product -%}
      {% render 'configurator-product-json', product: product %}
    {%- else -%}null{%- endif -%},

    {%- comment -%} Diagram images (Steps 14-15) {%- endcomment -%}
    "diagrams": {
      "controls": {
        "image": {% if section.settings.diagram_controls %}{{ section.settings.diagram_controls | image_url: width: 800 | json }}{% else %}null{% endif %}
      },
      "heater_conn": {
        "straight": {% if section.settings.diagram_heater_straight %}{{ section.settings.diagram_heater_straight | image_url: width: 600 | json }}{% else %}null{% endif %},
        "angle": {% if section.settings.diagram_heater_angle %}{{ section.settings.diagram_heater_angle | image_url: width: 600 | json }}{% else %}null{% endif %}
      }
    }
  }
  </script>
</{{ tag_name }}>

<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.7/dist/purify.min.js" defer></script>
<script src="{{ 'configurator.js' | asset_url }}" defer></script>

{%- comment -%} ═══════════ SCHEMA ═══════════ {%- endcomment -%}
{% schema %}
{
  "name": "Hot Tub Configurator",
  "settings": [
    { "type": "header", "content": "Step 1 — Base Products (Model Tiers)" },
    { "type": "collection", "id": "base_classic_collection", "label": "Nordic Elite Classic collection" },
    { "type": "collection", "id": "base_premium_collection", "label": "Nordic Elite Premium collection" },
    { "type": "collection", "id": "base_signature_collection", "label": "Nordic Elite Signature collection" },

    { "type": "header", "content": "Step 2 — Fiberglass Liners" },
    { "type": "collection", "id": "liners_collection", "label": "Liners collection" },

    { "type": "header", "content": "Step 3 — Insulation" },
    { "type": "product", "id": "insulation_product", "label": "Insulation product" },

    { "type": "header", "content": "Step 4 — Heating System" },
    { "type": "collection", "id": "oven_addons_collection", "label": "Oven add-ons (glass door, chimney)" },

    { "type": "header", "content": "Step 5 — Exterior Panels" },
    { "type": "collection", "id": "exteriors_collection", "label": "Exterior panels collection" },

    { "type": "header", "content": "Step 6 — Hydro Massage" },
    { "type": "collection", "id": "hydro_collection", "label": "Hydro massage collection" },

    { "type": "header", "content": "Step 7 — Air System" },
    { "type": "collection", "id": "air_collection", "label": "Air system collection" },

    { "type": "header", "content": "Step 8 — Filter System" },
    { "type": "collection", "id": "filters_collection", "label": "Filter system collection" },

    { "type": "header", "content": "Step 9 — LED Lighting" },
    { "type": "collection", "id": "leds_collection", "label": "LED lighting collection" },

    { "type": "header", "content": "Step 10 — Thermometer" },
    { "type": "collection", "id": "thermometers_collection", "label": "Thermometer collection" },

    { "type": "header", "content": "Step 11 — Stairs" },
    { "type": "product", "id": "stairs_product", "label": "Stairs product" },

    { "type": "header", "content": "Step 12 — Head Pillows" },
    { "type": "product", "id": "pillows_product", "label": "Head pillow product" },

    { "type": "header", "content": "Step 13 — Covers" },
    { "type": "collection", "id": "covers_collection", "label": "Covers collection" },

    { "type": "header", "content": "Step 15 — Heater Connection" },
    { "type": "product", "id": "heater_90_product", "label": "90° angle connection product" },

    { "type": "header", "content": "Diagram Images (Steps 14-15)" },
    { "type": "image_picker", "id": "diagram_controls", "label": "Control installation diagram" },
    { "type": "image_picker", "id": "diagram_heater_straight", "label": "Heater — straight connection" },
    { "type": "image_picker", "id": "diagram_heater_angle", "label": "Heater — 90° angle connection" },

    { "type": "header", "content": "Design" },
    { "type": "image_picker", "id": "default_image", "label": "Default image (before selection)" },
    { "type": "url", "id": "specs_page", "label": "Full specifications page URL" },
    { "type": "color", "id": "background_color", "label": "Background", "default": "#ffffff" },
    { "type": "range", "id": "padding_top", "label": "Top padding", "min": 0, "max": 100, "step": 4, "default": 40, "unit": "px" },
    { "type": "range", "id": "padding_bottom", "label": "Bottom padding", "min": 0, "max": 100, "step": 4, "default": 40, "unit": "px" }
  ],
  "presets": [
    { "name": "Hot Tub Configurator" }
  ]
}
{% endschema %}
