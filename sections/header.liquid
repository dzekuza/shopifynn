{%- liquid
  assign logo = settings.logo
  assign logo_width = settings.logo_width
  assign mega_trigger = section.settings.mega_menu_trigger | strip | downcase
-%}

{% if section.settings.sticky_header %}
  <style>#shopify-section-{{ section.id }} { position: sticky; top: 0; z-index: 100; }</style>
{% endif %}
<style>
  .header[data-header-id="{{ section.id }}"] {
    --header-bg: {{ section.settings.bg_color }};
    --header-text: {{ section.settings.text_color }};
    --header-sticky-bg: {{ section.settings.sticky_bg_color }};
    --header-sticky-text: {{ section.settings.sticky_text_color }};
  }
  {% if section.settings.transparent_header %}
    #main-content { margin-top: calc(-1 * var(--header-total-height, 72px)); }
  {% endif %}
</style>
<header
  class="header {% if section.settings.sticky_header %}header--sticky{% endif %}{% if section.settings.transparent_header %} header--transparent{% endif %}"
  data-header
  data-header-id="{{ section.id }}"
  {% if section.settings.transparent_header %}data-header-transparent{% endif %}
>
  {%- assign announcement_blocks = section.blocks | where: "type", "announcement_item" -%}
  {% if announcement_blocks.size > 0 %}
    <div class="announcement-bar" style="background-color: {{ section.settings.announcement_bg_color }}; color: {{ section.settings.announcement_text_color }};">
      <div class="announcement-bar__inner container">
        {% for block in announcement_blocks %}
          <div class="announcement-bar__item" {{ block.shopify_attributes }}>
            {% case block.settings.icon %}
              {% when 'shield' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg>
              {% when 'pin' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
              {% when 'globe' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
              {% when 'star' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              {% when 'truck' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
              {% when 'heart' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
              {% when 'check' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="9 12 11 14 15 10"/></svg>
              {% when 'leaf' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.25 3.75 1.25 3.75"/></svg>
              {% when 'award' %}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
            {% endcase %}
            <span>{{ block.settings.text }}</span>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="header__inner container">
    <a href="/" class="header__logo">
      {% if logo %}
        {%- assign logo_width_2x = logo_width | times: 2 -%}
        {%- assign logo_width_3x = logo_width | times: 3 -%}
        <img
          src="{{ logo | image_url: width: logo_width_2x }}"
          srcset="{{ logo | image_url: width: logo_width }} 1x, {{ logo | image_url: width: logo_width_2x }} 2x, {{ logo | image_url: width: logo_width_3x }} 3x"
          alt="{{ shop.name }}"
          width="{{ logo_width }}"
          height="{{ logo_width | divided_by: logo.aspect_ratio }}"
          loading="eager"
        >
      {% else %}
        <span class="header__logo-text">{{ settings.logo_text }}</span>
      {% endif %}
    </a>

    <nav class="header__nav" data-nav>
      {% for link in section.settings.menu.links %}
        {%- assign link_title_lower = link.title | strip | downcase -%}
        {% if link.links.size > 0 and link_title_lower == mega_trigger %}
          {%- comment -%} ===== MEGA MENU (only for the selected trigger item) ===== {%- endcomment -%}
          <div class="header__mega" data-dropdown>
            <button type="button" class="header__nav-link header__nav-link--parent {% if link.active or link.child_active %}is-active{% endif %}" data-dropdown-trigger aria-expanded="false">
              {{ link.title }}
              <svg class="header__chevron" width="10" height="6" viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
            </button>
            <div class="header__mega-panel" data-dropdown-menu>
              <div class="header__mega-inner container">
                <div class="header__mega-products">
                  {% for child in link.links %}
                    {%- assign child_object = child.object -%}
                    {% if child.type == 'collection_link' and child_object.products.size > 0 %}
                      {%- assign featured_product = child_object.products.first -%}
                      <a href="{{ child.url }}" class="header__mega-product">
                        <div class="header__mega-product-image">
                          {% if featured_product.featured_image %}
                            <img
                              src="{{ featured_product.featured_image | image_url: width: 300 }}"
                              alt="{{ child.title | escape }}"
                              loading="lazy"
                              width="150"
                              height="150"
                            >
                          {% elsif child_object.image %}
                            <img
                              src="{{ child_object.image | image_url: width: 300 }}"
                              alt="{{ child.title | escape }}"
                              loading="lazy"
                              width="150"
                              height="150"
                            >
                          {% else %}
                            <div class="header__mega-product-placeholder">
                              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                            </div>
                          {% endif %}
                        </div>
                        <span class="header__mega-product-title">{{ child.title }}</span>
                      </a>
                    {% endif %}
                  {% endfor %}
                </div>

                <div class="header__mega-links">
                  {% for child in link.links %}
                    <a href="{{ child.url }}" class="header__mega-link {% if child.active %}is-active{% endif %}">
                      {{ child.title }}
                    </a>
                  {% endfor %}

                  {% if section.settings.quiz_text != blank %}
                    <a href="{{ section.settings.quiz_url }}" class="header__mega-cta">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                      {{ section.settings.quiz_text | upcase }}
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% elsif link.links.size > 0 %}
          {%- comment -%} ===== REGULAR DROPDOWN (all other items with children) ===== {%- endcomment -%}
          <div class="header__dropdown" data-dropdown>
            <button type="button" class="header__nav-link header__nav-link--parent {% if link.active or link.child_active %}is-active{% endif %}" data-dropdown-trigger aria-expanded="false">
              {{ link.title }}
              <svg class="header__chevron" width="10" height="6" viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
            </button>
            <div class="header__dropdown-menu" data-dropdown-menu>
              {% for child in link.links %}
                <a href="{{ child.url }}" class="header__dropdown-link {% if child.active %}is-active{% endif %}">
                  {{ child.title }}
                </a>
              {% endfor %}
            </div>
          </div>
        {% else %}
          {%- comment -%} ===== SIMPLE LINK (no children) ===== {%- endcomment -%}
          <a href="{{ link.url }}" class="header__nav-link {% if link.active %}is-active{% endif %}">
            {{ link.title }}
          </a>
        {% endif %}
      {% endfor %}
    </nav>

    <div class="header__actions">
      {% if section.settings.quiz_text != blank %}
        <a href="{{ section.settings.quiz_url }}" class="header__cta button button--primary">{{ section.settings.quiz_text }}</a>
      {% endif %}
      <a href="/cart" class="header__cart" aria-label="Cart" data-cart-drawer-toggle>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
          <path d="M16 10a4 4 0 01-8 0"/>
        </svg>
        <span class="header__cart-count" data-cart-count>{{ cart.item_count }}</span>
      </a>

      <button class="header__menu-toggle" data-menu-toggle aria-label="Menu" aria-expanded="false">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="header__mobile-nav" data-mobile-nav>
    <div class="header__mobile-nav-inner">
      {% for link in section.settings.menu.links %}
        {% if link.links.size > 0 %}
          <div class="header__mobile-group" data-mobile-dropdown>
            <button type="button" class="header__mobile-link header__mobile-link--parent" data-mobile-dropdown-trigger aria-expanded="false">
              {{ link.title }}
              <svg class="header__mobile-chevron" width="14" height="8" viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
            </button>
            <div class="header__mobile-submenu" data-mobile-submenu>
              {% for child in link.links %}
                <a href="{{ child.url }}" class="header__mobile-sublink">{{ child.title }}</a>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <a href="{{ link.url }}" class="header__mobile-link">{{ link.title }}</a>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</header>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Navigation menu",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "sticky_header",
      "label": "Sticky header",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "transparent_header",
      "label": "Transparent header",
      "info": "Makes the header transparent and overlays on top of the first section. Useful for hero banners.",
      "default": false
    },
    {
      "type": "header",
      "content": "Default colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#F5F7F6"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#1E2D3B"
    },
    {
      "type": "header",
      "content": "Sticky / scrolled colors"
    },
    {
      "type": "color",
      "id": "sticky_bg_color",
      "label": "Background color",
      "default": "#F5F7F6"
    },
    {
      "type": "color",
      "id": "sticky_text_color",
      "label": "Text color",
      "default": "#1E2D3B"
    },
    {
      "type": "text",
      "id": "mega_menu_trigger",
      "label": "Mega menu item title",
      "info": "Enter the exact title of the menu item that should use the mega menu (e.g. \"Products\"). All other items with children will use a regular dropdown.",
      "default": "Products"
    },
    {
      "type": "header",
      "content": "CTA Button"
    },
    {
      "type": "text",
      "id": "quiz_text",
      "label": "CTA button text",
      "default": "Help me choose"
    },
    {
      "type": "url",
      "id": "quiz_url",
      "label": "CTA button link"
    },
    {
      "type": "header",
      "content": "Announcement Bar"
    },
    {
      "type": "color",
      "id": "announcement_bg_color",
      "label": "Background color",
      "default": "#1E2D3B"
    },
    {
      "type": "color",
      "id": "announcement_text_color",
      "label": "Text color",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "announcement_item",
      "name": "Announcement Item",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Free shipping"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            { "value": "shield", "label": "Shield (warranty)" },
            { "value": "pin", "label": "Pin (location)" },
            { "value": "globe", "label": "Globe (worldwide)" },
            { "value": "star", "label": "Star (rating)" },
            { "value": "truck", "label": "Truck (shipping)" },
            { "value": "heart", "label": "Heart" },
            { "value": "check", "label": "Checkmark" },
            { "value": "leaf", "label": "Leaf (eco)" },
            { "value": "award", "label": "Award" }
          ],
          "default": "check"
        }
      ]
    }
  ]
}
{% endschema %}
