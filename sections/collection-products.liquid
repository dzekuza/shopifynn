<section class="collection-products section {% if section.settings.color_scheme == 'surface' %}section--surface{% elsif section.settings.color_scheme == 'dark' %}section--dark{% endif %}" style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;">
  <div class="container">
    {% if section.settings.heading != blank or section.settings.subheading != blank %}
      <div class="section__header" style="text-align: {{ section.settings.text_alignment }};">
        {% if section.settings.heading != blank %}
          <h2 class="section__heading" style="{% render 'heading-size-vars', desktop: section.settings.heading_size, mobile: section.settings.heading_size_mobile %}">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.subheading != blank %}
          <p class="section__subheading" style="font-size: {% if section.settings.text_size == 'small' %}0.875rem{% elsif section.settings.text_size == 'large' %}1.125rem{% else %}1rem{% endif %};">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}

    {%- assign collection = section.settings.collection -%}
    {%- assign product_limit = section.settings.product_limit -%}
    {%- assign columns = section.settings.columns -%}
    {%- assign layout = section.settings.layout -%}

    {% if collection != blank %}
      {% if layout == 'carousel' %}
        <div class="collection-products__carousel-wrap">
          <div class="collection-products__carousel" data-carousel data-columns="{{ columns }}" data-mobile-columns="{{ section.settings.mobile_columns }}">
            {% for product in collection.products limit: product_limit %}
              <div class="collection-products__slide">
                {% render 'product-card', product: product, show_secondary_image: section.settings.show_secondary_image, show_vendor: section.settings.show_vendor %}
              </div>
            {% endfor %}
          </div>
          <div class="collection-products__nav">
            <button class="collection-products__arrow collection-products__arrow--prev" data-carousel-prev aria-label="Previous products">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <button class="collection-products__arrow collection-products__arrow--next" data-carousel-next aria-label="Next products">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
          </div>
        </div>
      {% else %}
        <div class="collection-products__grid collection-products__grid--{{ columns }} collection-products__grid--mobile-{{ section.settings.mobile_columns }}" style="gap: {{ section.settings.grid_gap }}px;">
          {% for product in collection.products limit: product_limit %}
            {% render 'product-card', product: product, show_secondary_image: section.settings.show_secondary_image, show_vendor: section.settings.show_vendor %}
          {% endfor %}
        </div>
      {% endif %}

      {% if section.settings.show_view_all %}
        <div class="collection-products__view-all" style="text-align: center; margin-top: 40px;">
          <a href="{{ collection.url }}" class="button {% if section.settings.view_all_style == 'outline' %}button--outline{% else %}button--primary{% endif %}">
            {{ section.settings.view_all_text | default: 'View all' }}
          </a>
        </div>
      {% endif %}
    {% else %}
      <p class="collection-products__empty">Select a collection in the theme editor.</p>
    {% endif %}
  </div>
</section>

<script>
  (function () {
    document.querySelectorAll('[data-carousel]').forEach(function (carousel) {
      var cols = parseInt(carousel.getAttribute('data-columns')) || 4;
      var mobileCols = parseInt(carousel.getAttribute('data-mobile-columns')) || 2;
      var slides = carousel.querySelectorAll('.collection-products__slide');
      var total = slides.length;
      var offset = 0;
      var wrap = carousel.closest('.collection-products__carousel-wrap');
      var prevBtn = wrap.querySelector('[data-carousel-prev]');
      var nextBtn = wrap.querySelector('[data-carousel-next]');
      var gap = 24;

      function getVisible() {
        var w = window.innerWidth;
        if (w < 600) return mobileCols;
        if (w < 900) return Math.min(cols, 3);
        return cols;
      }

      function update() {
        var visible = getVisible();
        var maxOffset = Math.max(0, total - visible);
        if (offset > maxOffset) offset = maxOffset;

        var wrapWidth = wrap.offsetWidth;
        var slideWidth = (wrapWidth - gap * (visible - 1)) / visible;

        slides.forEach(function (s) {
          s.style.flex = '0 0 ' + slideWidth + 'px';
        });

        var translatePx = offset * (slideWidth + gap);
        carousel.style.transform = 'translateX(-' + translatePx + 'px)';
        carousel.style.transition = 'transform 0.4s ease';

        if (prevBtn) prevBtn.disabled = offset === 0;
        if (nextBtn) nextBtn.disabled = offset >= maxOffset;
      }

      if (prevBtn) prevBtn.addEventListener('click', function () { offset = Math.max(0, offset - 1); update(); });
      if (nextBtn) nextBtn.addEventListener('click', function () { var visible = getVisible(); var maxOffset = Math.max(0, total - visible); offset = Math.min(maxOffset, offset + 1); update(); });
      window.addEventListener('resize', update);
      update();
    });
  })();
</script>

{% schema %}
{
  "name": "Collection Products",
  "settings": [
    {
      "type": "header",
      "content": "Collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "product_limit",
      "label": "Maximum products",
      "min": 2,
      "max": 24,
      "step": 1,
      "default": 8
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Products"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "heading_size_mobile",
      "label": "Heading size (mobile)",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "text_size",
      "label": "Text size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "carousel", "label": "Carousel" }
      ],
      "default": "grid"
    },
    {
      "type": "select",
      "id": "columns",
      "label": "Products per row (desktop)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" },
        { "value": "5", "label": "5" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "mobile_columns",
      "label": "Products per row (mobile)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Grid gap",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Product card"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "label": "Show secondary image on hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "header",
      "content": "View all"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show 'View all' button",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "Button text",
      "default": "View all"
    },
    {
      "type": "select",
      "id": "view_all_style",
      "label": "Button style",
      "options": [
        { "value": "primary", "label": "Primary (filled)" },
        { "value": "outline", "label": "Outline" }
      ],
      "default": "outline"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "surface", "label": "Surface" },
        { "value": "dark", "label": "Dark" }
      ],
      "default": "default"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 40,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Collection Products"
    }
  ]
}
{% endschema %}
