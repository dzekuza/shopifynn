{%- liquid
  assign upsell_blocks = section.blocks | where: "type", "upsell_product"
-%}

<div class="section cart-page" data-cart-page>
  <div class="container">
    {% if cart.item_count == 0 %}
      <div class="cart-page__empty">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="1">
          <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/>
        </svg>
        <h1 class="cart-page__empty-title">{{ section.settings.empty_title }}</h1>
        <p class="cart-page__empty-text">{{ section.settings.empty_text }}</p>
        <a href="{{ section.settings.empty_button_link }}" class="button button--primary">{{ section.settings.empty_button_text }}</a>
      </div>
    {% else %}
      <div class="cart-page__header">
        <h1 class="cart-page__title">{{ section.settings.heading }}</h1>
        <p class="cart-page__count">{{ cart.item_count }} {{ cart.item_count | pluralize: 'item', 'items' }}</p>
      </div>

      <div class="cart-page__layout">
        <div class="cart-page__items">
          <form action="/cart" method="post" data-cart-form>
            {% for item in cart.items %}
              <div class="cart-item" data-cart-item data-line="{{ forloop.index }}" data-key="{{ item.key }}">
                <a href="{{ item.url }}" class="cart-item__image-wrap">
                  {% if item.image %}
                    <img
                      src="{{ item.image | image_url: width: 240 }}"
                      srcset="{{ item.image | image_url: width: 120 }} 120w, {{ item.image | image_url: width: 240 }} 240w"
                      sizes="120px"
                      alt="{{ item.title | escape }}"
                      loading="lazy"
                      class="cart-item__image"
                    >
                  {% else %}
                    <div class="cart-item__placeholder">
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="1">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                      </svg>
                    </div>
                  {% endif %}
                </a>

                <div class="cart-item__details">
                  <div class="cart-item__top">
                    <div class="cart-item__info">
                      <a href="{{ item.url }}" class="cart-item__title">{{ item.product.title }}</a>
                      {% unless item.product.has_only_default_variant %}
                        <p class="cart-item__variant">{{ item.variant.title }}</p>
                      {% endunless %}
                      {% if item.selling_plan_allocation %}
                        <p class="cart-item__variant">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                      {% endif %}
                    </div>
                    <button type="button" class="cart-item__remove" data-cart-remove data-line="{{ forloop.index }}" aria-label="Remove {{ item.title }}">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </button>
                  </div>

                  <div class="cart-item__bottom">
                    <div class="cart-item__quantity" data-quantity-selector>
                      <button type="button" class="cart-item__qty-btn" data-cart-qty-minus data-line="{{ forloop.index }}" aria-label="Decrease quantity">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                      </button>
                      <input type="number" class="cart-item__qty-input" value="{{ item.quantity }}" min="1" data-cart-qty-input data-line="{{ forloop.index }}" aria-label="Quantity">
                      <button type="button" class="cart-item__qty-btn" data-cart-qty-plus data-line="{{ forloop.index }}" aria-label="Increase quantity">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                      </button>
                    </div>

                    <div class="cart-item__prices">
                      {% if item.original_line_price != item.final_line_price %}
                        <span class="cart-item__compare-price">{{ item.original_line_price | money }}</span>
                      {% endif %}
                      <span class="cart-item__price">{{ item.final_line_price | money }}</span>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </form>
        </div>

        <div class="cart-page__sidebar">
          {% if section.settings.show_order_note %}
            <div class="cart-page__note">
              <label for="cart-note" class="cart-page__note-label">{{ section.settings.note_label }}</label>
              <textarea id="cart-note" name="note" class="cart-page__note-input" data-cart-note placeholder="{{ section.settings.note_placeholder }}">{{ cart.note }}</textarea>
            </div>
          {% endif %}

          <div class="cart-page__summary">
            {% if cart.cart_level_discount_applications.size > 0 %}
              {% for discount in cart.cart_level_discount_applications %}
                <div class="cart-page__discount">
                  <span>{{ discount.title }}</span>
                  <span>-{{ discount.total_allocated_amount | money }}</span>
                </div>
              {% endfor %}
            {% endif %}

            <div class="cart-page__subtotal">
              <span>Subtotal</span>
              <span data-cart-subtotal>{{ cart.total_price | money }}</span>
            </div>

            <p class="cart-page__shipping-note">{{ section.settings.shipping_note }}</p>

            <a href="/checkout" class="button button--primary cart-page__checkout">
              {{ section.settings.checkout_text }}
            </a>

            <a href="/collections/all" class="cart-page__continue">{{ section.settings.continue_text }}</a>
          </div>

          {% if upsell_blocks.size > 0 %}
            <div class="cart-page__upsells">
              <h3 class="cart-page__upsells-title">{{ section.settings.upsell_heading }}</h3>
              <div class="cart-page__upsells-grid">
                {% for block in upsell_blocks %}
                  {%- assign upsell_product = block.settings.product -%}
                  {% if upsell_product != blank and upsell_product.available %}
                    {%- assign already_in_cart = false -%}
                    {% for item in cart.items %}
                      {% if item.product.id == upsell_product.id %}
                        {%- assign already_in_cart = true -%}
                        {% break %}
                      {% endif %}
                    {% endfor %}

                    {% unless already_in_cart %}
                      <div class="cart-upsell" {{ block.shopify_attributes }}>
                        <a href="{{ upsell_product.url }}" class="cart-upsell__image-wrap">
                          {% if upsell_product.featured_image %}
                            <img
                              src="{{ upsell_product.featured_image | image_url: width: 200 }}"
                              alt="{{ upsell_product.title | escape }}"
                              loading="lazy"
                              class="cart-upsell__image"
                            >
                          {% endif %}
                        </a>
                        <div class="cart-upsell__info">
                          <a href="{{ upsell_product.url }}" class="cart-upsell__title">{{ upsell_product.title }}</a>
                          <span class="cart-upsell__price">{{ upsell_product.price | money }}</span>
                        </div>
                        <button
                          type="button"
                          class="cart-upsell__add"
                          data-upsell-add
                          data-variant-id="{{ upsell_product.first_available_variant.id }}"
                          aria-label="Add {{ upsell_product.title }}"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                          Add
                        </button>
                      </div>
                    {% endunless %}
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Cart",
  "settings": [
    {
      "type": "header",
      "content": "Cart page"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Your Cart"
    },
    {
      "type": "text",
      "id": "checkout_text",
      "label": "Checkout button text",
      "default": "Proceed to Checkout"
    },
    {
      "type": "text",
      "id": "continue_text",
      "label": "Continue shopping text",
      "default": "Continue Shopping"
    },
    {
      "type": "text",
      "id": "shipping_note",
      "label": "Shipping note",
      "default": "Shipping & taxes calculated at checkout"
    },
    {
      "type": "header",
      "content": "Order note"
    },
    {
      "type": "checkbox",
      "id": "show_order_note",
      "label": "Show order note",
      "default": true
    },
    {
      "type": "text",
      "id": "note_label",
      "label": "Note label",
      "default": "Order notes"
    },
    {
      "type": "text",
      "id": "note_placeholder",
      "label": "Note placeholder",
      "default": "Special instructions for your order..."
    },
    {
      "type": "header",
      "content": "Empty cart"
    },
    {
      "type": "text",
      "id": "empty_title",
      "label": "Empty title",
      "default": "Your cart is empty"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty text",
      "default": "Looks like you haven't added anything yet."
    },
    {
      "type": "text",
      "id": "empty_button_text",
      "label": "Empty button text",
      "default": "Start Shopping"
    },
    {
      "type": "url",
      "id": "empty_button_link",
      "label": "Empty button link",
      "default": "/collections/all"
    },
    {
      "type": "header",
      "content": "Upsells"
    },
    {
      "type": "text",
      "id": "upsell_heading",
      "label": "Upsell heading",
      "default": "You might also like"
    }
  ],
  "blocks": [
    {
      "type": "upsell_product",
      "name": "Upsell product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ]
}
{% endschema %}
