---
phase: 09-cart-integration-milestone-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/theme.js
  - .planning/ROADMAP.md
  - .planning/phases/01-security-foundation/01-VERIFICATION.md
  - .planning/phases/02-configurator-stabilization/02-VERIFICATION.md
  - .planning/phases/04-visual-polish-and-brand-content/04-VERIFICATION.md
autonomous: true
requirements:
  - CONF-06

must_haves:
  truths:
    - "After add-to-cart in the configurator, the header [data-cart-count] element updates to the new item count without page reload"
    - "VERIFICATION.md exists for Phase 1 with pass/fail results for SEC-01, SEC-02, SEC-03, ARCH-04"
    - "VERIFICATION.md exists for Phase 2 with pass/fail results for CONF-05, CONF-06, CONF-09, ARCH-03"
    - "VERIFICATION.md exists for Phase 4 with pass/fail results for VIS-01, VIS-02, VIS-03, VIS-04, BRAND-01, BRAND-02, BRAND-03"
    - "All plan-level entries in ROADMAP.md for Phases 1-8 show [x] checkboxes"
  artifacts:
    - path: "assets/theme.js"
      provides: "cart:refresh event listener that fetches /cart.js and updates [data-cart-count]"
      contains: "cart:refresh"
    - path: ".planning/phases/01-security-foundation/01-VERIFICATION.md"
      provides: "Phase 1 verification report"
      contains: "SEC-01"
    - path: ".planning/phases/02-configurator-stabilization/02-VERIFICATION.md"
      provides: "Phase 2 verification report"
      contains: "CONF-06"
    - path: ".planning/phases/04-visual-polish-and-brand-content/04-VERIFICATION.md"
      provides: "Phase 4 verification report"
      contains: "VIS-01"
  key_links:
    - from: "assets/configurator.js"
      to: "assets/theme.js"
      via: "window.dispatchEvent(new CustomEvent('cart:refresh')) -> window.addEventListener('cart:refresh', ...)"
      pattern: "cart:refresh"
    - from: "assets/theme.js"
      to: "/cart.js"
      via: "fetch('/cart.js') to read item_count"
      pattern: "fetch.*cart\\.js"
    - from: "assets/theme.js"
      to: "sections/header.liquid"
      via: "querySelector('[data-cart-count]').textContent = cart.item_count"
      pattern: "data-cart-count"
---

<objective>
Wire the orphaned `cart:refresh` CustomEvent listener in theme.js so the header cart badge updates after add-to-cart, create missing VERIFICATION.md files for Phases 1/2/4, and fix all plan-level checkboxes in ROADMAP.md.

Purpose: Close the last integration gap (configurator dispatches cart:refresh but nothing listens) and complete milestone documentation so all phases have auditable verification records.
Output: Updated theme.js with cart listener, three VERIFICATION.md files, corrected ROADMAP.md checkboxes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cart-integration-milestone-cleanup/09-RESEARCH.md

# Source material for VERIFICATION.md creation
@.planning/phases/01-security-foundation/01-01-SUMMARY.md
@.planning/phases/01-security-foundation/01-02-SUMMARY.md
@.planning/phases/02-configurator-stabilization/02-01-SUMMARY.md
@.planning/phases/02-configurator-stabilization/02-02-SUMMARY.md
@.planning/phases/02-configurator-stabilization/02-03-SUMMARY.md
@.planning/phases/02-configurator-stabilization/02-04-SUMMARY.md
@.planning/phases/02-configurator-stabilization/02-05-SUMMARY.md
@.planning/phases/04-visual-polish-and-brand-content/04-01-SUMMARY.md
@.planning/phases/04-visual-polish-and-brand-content/04-02-SUMMARY.md

# Existing VERIFICATION.md format reference
@.planning/phases/08-css-architecture-themejs-cleanup/08-VERIFICATION.md

# Files to modify
@assets/theme.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire cart:refresh listener in theme.js and fix ROADMAP checkboxes</name>
  <files>assets/theme.js, .planning/ROADMAP.md</files>
  <action>
**theme.js — Add cart:refresh listener:**

Add a new section inside the existing IIFE in `assets/theme.js`. Place it after the last existing feature section (look for the final `/* ---- ... ---- */` banner) and before the closing `})();`. Use the existing banner style:

```javascript
/* ---- Cart Count Update ---- */

window.addEventListener('cart:refresh', () => {
  fetch('/cart.js')
    .then(r => r.json())
    .then(cart => {
      const el = document.querySelector('[data-cart-count]');
      if (el) el.textContent = cart.item_count;
    })
    .catch(() => {});
});
```

Key rules:
- Listen on `window` (not `document`) — matches the dispatch in configurator.js line ~1595: `window.dispatchEvent(new CustomEvent('cart:refresh'))`
- Use `textContent` (not `innerHTML`) — the count is always an integer, no XSS surface
- Use arrow functions — consistent with the rest of theme.js inside the IIFE
- Include `.catch(() => {})` — cart count update is non-critical; swallow network errors silently
- Use `const` for the element reference — no `var` (project convention from Phase 8)

**ROADMAP.md — Fix plan-level checkboxes:**

In `.planning/ROADMAP.md`, find all plan-level entries for completed Phases 1-8 that show `- [ ]` and change them to `- [x]`. This is a batch find-and-replace within the Phase Details section. Every plan entry for Phases 1 through 8 (all completed phases) should be checked: `01-01-PLAN.md`, `01-02-PLAN.md`, `02-01` through `02-05`, `03-01` through `03-05`, `04-01`, `04-02`, `05-01`, `06-01`, `06-02`, `07-01`, `08-01`. All become `- [x]`.

Do NOT change the Phase 9 plan entry — it should remain `- [ ]` as it is the current executing plan.
  </action>
  <verify>
1. `grep -c "cart:refresh" assets/theme.js` returns 1 (the listener)
2. `grep "cart:refresh" assets/theme.js` shows `window.addEventListener('cart:refresh'`
3. `grep -c "fetch.*cart.js" assets/theme.js` returns 1
4. `grep "\bvar\b" assets/theme.js` returns nothing (no regression on Phase 8 cleanup)
5. In ROADMAP.md, `grep -c "\- \[ \]" .planning/ROADMAP.md` returns exactly 1 (only Phase 9's plan entry)
6. `grep -c "\- \[x\]" .planning/ROADMAP.md` returns 19 (all 19 completed plan entries for Phases 1-8)
  </verify>
  <done>
The cart:refresh event listener exists in theme.js, uses fetch('/cart.js') to get item_count, updates [data-cart-count] via textContent, swallows errors silently. All ROADMAP plan checkboxes for Phases 1-8 are [x]. Phase 9 plan remains [ ].
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VERIFICATION.md for Phases 1, 2, and 4</name>
  <files>.planning/phases/01-security-foundation/01-VERIFICATION.md, .planning/phases/02-configurator-stabilization/02-VERIFICATION.md, .planning/phases/04-visual-polish-and-brand-content/04-VERIFICATION.md</files>
  <action>
Create three VERIFICATION.md files using the same format as `08-VERIFICATION.md`. Each file must have YAML frontmatter and the standard sections: Goal Achievement (Observable Truths table), Required Artifacts, Key Link Verification, Requirements Coverage.

**For each file, actively verify claims by running grep/file checks against the current codebase** — do not just copy SUMMARY claims. The SUMMARY files are source material for what was implemented, but verification must confirm the code still exists after subsequent phases.

**01-VERIFICATION.md (Phase 1: Security Foundation):**
- Frontmatter: `phase: 01-security-foundation`, `status: passed`, `score: 3/3 must-haves verified`
- Requirements to verify: SEC-01, SEC-02, SEC-03
  - SEC-01: `grep -r "shpss_\|shpat_\|CLIENT_SECRET.*=" scripts/` returns clean (no hardcoded secrets)
  - SEC-02: `git log --all --full-history -- "scripts/*.mjs"` confirms scripts were never tracked (no purge needed)
  - SEC-03: `.env` in `.gitignore` + scripts use `process.env.STORE`, `process.env.CLIENT_ID`, `process.env.CLIENT_SECRET`
- Note: ARCH-04 (var→const/let in theme.js) was initially addressed in Phase 1 but was superseded by Phase 8 which re-did the full migration. Mark ARCH-04 as "superseded by Phase 8" in the requirements table.

**02-VERIFICATION.md (Phase 2: Configurator Stabilization):**
- Frontmatter: `phase: 02-configurator-stabilization`, `status: passed`, `score: 4/4 must-haves verified`
- Requirements to verify: CONF-05, CONF-06, CONF-09, ARCH-03
  - CONF-05: grep for `_validateRequiredSteps` definition and call in `_handleAddToCart()` in `assets/configurator.js`
  - CONF-06: grep for `_showError` method, `retry-cart` action in `_bindEvents()`, and the retry button DOM creation in `assets/configurator.js`. Note: the cart badge update integration (cart:refresh listener) is addressed in Phase 9 — CONF-06's core requirement (error recovery with retry) is satisfied
  - CONF-09: grep for `_buildConfigSummary` and its usage in `_buildCartItems()` storing as line item property
  - ARCH-03: grep for `══` banner comments in `assets/configurator.js` — verify 8 banners exist
- Note: CONF-01/02/03/04/07/08 were addressed in Phases 6 and 7 (gap closure). Phase 2 VERIFICATION covers only the requirements that Phase 2 was the final implementor for.

**04-VERIFICATION.md (Phase 4: Visual Polish and Brand Content):**
- Frontmatter: `phase: 04-visual-polish-and-brand-content`, `status: passed`, `score: 7/7 must-haves verified`
- Requirements to verify: VIS-01, VIS-02, VIS-03, VIS-04, BRAND-01, BRAND-02, BRAND-03
  - VIS-01: grep `assets/theme.css` for hero section polish indicators (letter-spacing, refined spacing)
  - VIS-02: grep for features section CSS improvements in `assets/theme.css`
  - VIS-03: grep for testimonials/author styling in `assets/theme.css`
  - VIS-04: grep `assets/theme.js` for GSAP animation consistency (power3.out or similar unified easing)
  - BRAND-01: verify `templates/page.about.json` file exists
  - BRAND-02: verify `page.about.json` references sections with artisan/manufacturing content
  - BRAND-03: verify the about template composes multiple editorial sections (not a single text block)
- Include a "Human Verification Required" section noting that visual quality (luxury tier, editorial layout) requires subjective human review — automated checks confirm CSS values and file existence only.
  </action>
  <verify>
1. `ls .planning/phases/01-security-foundation/01-VERIFICATION.md` exists
2. `ls .planning/phases/02-configurator-stabilization/02-VERIFICATION.md` exists
3. `ls .planning/phases/04-visual-polish-and-brand-content/04-VERIFICATION.md` exists
4. Each file has YAML frontmatter with `phase`, `verified`, `status`, `score` fields
5. Each file has Observable Truths table, Required Artifacts table, Requirements Coverage table
6. grep results in each file reflect actual codebase state (not stale SUMMARY claims)
  </verify>
  <done>
Three VERIFICATION.md files exist with grep-verified evidence for all requirements. Phase 1 covers SEC-01/02/03 (ARCH-04 noted as superseded by Phase 8). Phase 2 covers CONF-05/06/09 and ARCH-03 (CONF-06 notes cart badge integration is Phase 9). Phase 4 covers VIS-01/02/03/04 and BRAND-01/02/03 with a human verification section for subjective visual quality.
  </done>
</task>

</tasks>

<verification>
1. **Cart integration:** `grep "cart:refresh" assets/theme.js` shows window.addEventListener listener; `grep "cart:refresh" assets/configurator.js` shows window.dispatchEvent — the dispatch→listen link is complete
2. **VERIFICATION coverage:** `ls .planning/phases/*/??-VERIFICATION.md` returns 8 files (Phases 1-8) — every completed phase has a verification report
3. **ROADMAP accuracy:** All plan entries for Phases 1-8 show `[x]`; Phase 9 plan shows `[ ]`
4. **No regressions:** `grep "\bvar\b" assets/theme.js` returns empty (Phase 8 var cleanup intact)
</verification>

<success_criteria>
- The header cart count badge updates immediately after configurator add-to-cart (no page reload needed)
- All 8 completed phases have VERIFICATION.md files with grep-verifiable evidence
- ROADMAP.md plan checkboxes accurately reflect completion state for all phases
- No var declarations introduced in theme.js
</success_criteria>

<output>
After completion, create `.planning/phases/09-cart-integration-milestone-cleanup/09-01-SUMMARY.md`
</output>
