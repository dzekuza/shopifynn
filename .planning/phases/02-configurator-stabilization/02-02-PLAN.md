---
phase: 02-configurator-stabilization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - snippets/configurator-product-json.liquid
  - assets/configurator.js
autonomous: true
requirements:
  - CONF-01
  - CONF-02
  - CONF-03

must_haves:
  truths:
    - "The configurator resolves product size from metafield data, not from product title regex"
    - "The configurator resolves oven type from metafield data, not from product title regex"
    - "No string-matching fallback methods exist in configurator.js"
  artifacts:
    - path: "snippets/configurator-product-json.liquid"
      provides: "Product JSON with size, oven_type, and addon_type metafields"
      contains: "configurator.size"
    - path: "assets/configurator.js"
      provides: "Metafield-based product resolution"
  key_links:
    - from: "snippets/configurator-product-json.liquid"
      to: "assets/configurator.js"
      via: "JSON blob with meta.size, meta.oven_type, meta.addon_type fields consumed by JS"
      pattern: "product\\.meta\\??\\.size"
---

<objective>
Replace fragile regex-based product title matching with metafield-based lookups. Extend the Liquid snippet to serialize size, oven_type, and addon_type metafields. Delete all string-matching fallback methods atomically.

Purpose: Product resolution currently uses regex on titles (e.g., matching "XL" or "internal" in product names). This breaks when product names change. Metafields are the stable, intended source of truth.
Output: Updated `configurator-product-json.liquid` with full metafield output, refactored `configurator.js` with metafield-only product resolution.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configurator-stabilization/02-RESEARCH.md

@snippets/configurator-product-json.liquid
@assets/configurator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Liquid snippet with metafield fields</name>
  <files>snippets/configurator-product-json.liquid</files>
  <action>
1. Read `snippets/configurator-product-json.liquid` and locate the `"meta"` object in the JSON output. It already includes `"oven_type"` from `product.metafields.configurator.oven_type.value`.

2. Add `"size"` and `"addon_type"` fields to the `"meta"` object using the same pattern:

```liquid
"size": {{ product.metafields.configurator.size.value | default: "" | json }},
"addon_type": {{ product.metafields.configurator.addon_type.value | default: "" | json }},
```

3. Ensure all three metafield keys are present in the `"meta"` object: `size`, `oven_type`, `addon_type`. The `| default: ""` ensures products without metafields get empty strings (not null/undefined which would break JS reads).

4. Verify the JSON structure remains valid — no trailing comma issues, proper nesting.
  </action>
  <verify>
- Grep `configurator-product-json.liquid` for `configurator.size` — must be present
- Grep for `configurator.addon_type` — must be present
- Grep for `configurator.oven_type` — must still be present
- JSON structure is syntactically valid (no orphaned commas)
  </verify>
  <done>The Liquid snippet outputs size, oven_type, and addon_type metafields for every product in the configurator JSON blob.</done>
</task>

<task type="auto">
  <name>Task 2: Replace string-matching with metafield reads and delete fallbacks</name>
  <files>assets/configurator.js</files>
  <action>
This is an ATOMIC change — metafield reads and string-matching deletion happen in the same edit.

1. Read `assets/configurator.js` and locate `_getSizeFromProduct()` (approximately lines 643-649 per research). Replace the entire method body with:

```javascript
_getSizeFromProduct(product) {
  return product.meta?.size || null;
}
```

This reads from the `meta.size` field populated by the Liquid snippet (Task 1).

2. Locate `_isInternalOvenProduct()` (approximately lines 651-654). Replace the entire method body with:

```javascript
_isInternalOvenProduct(product) {
  return product.meta?.oven_type === 'internal';
}
```

This reads from `meta.oven_type` which was already being serialized by the snippet.

3. Search the ENTIRE file for any other regex-based product title matching patterns. Common patterns to look for:
   - `/\bXL\b/i` or similar size regexes
   - `/internal|integr/i` or similar oven type regexes
   - `.title.match(` or `.title.includes(` used for product classification

   If any other string-matching fallbacks exist outside these two methods, replace them with metafield reads too.

4. Also add a `connectedCallback` guard per Research Pitfall 5 — at the very top of `connectedCallback()`, add:

```javascript
const dataEl = this.querySelector('[data-configurator-products]');
if (!dataEl) return; // Not in configurator context (e.g., theme editor)
```

This prevents JS errors when the section is loaded in Shopify theme editor outside the configurator template context.

5. Do NOT change any other logic (pricing, events, etc.) — those are handled in later plans.
  </action>
  <verify>
- Grep `configurator.js` for `_getSizeFromProduct` — method exists and body references `product.meta?.size`
- Grep for `_isInternalOvenProduct` — method exists and body references `product.meta?.oven_type`
- Grep for `/\\bXL\\b/` or `/\\bM\\b/` or `/\\bL\\b/` — NO regex-based size matching remains
- Grep for `/internal|integr/` — NO regex-based oven type matching remains
- Grep for `data-configurator-products` in connectedCallback — guard is present
  </verify>
  <done>Product resolution uses metafields exclusively. All string-matching fallbacks are deleted. Theme editor guard prevents null reference errors.</done>
</task>

</tasks>

<verification>
1. The configurator JSON blob (visible in page source on configurator page) includes `meta.size`, `meta.oven_type`, and `meta.addon_type` for each product
2. `_getSizeFromProduct()` returns the metafield value, not a regex match
3. `_isInternalOvenProduct()` checks `meta.oven_type === 'internal'`, not title regex
4. No regex patterns for product title matching exist anywhere in `configurator.js`
5. The configurator loads without JS errors in the Shopify theme editor
</verification>

<success_criteria>
- Product resolution is 100% metafield-based with zero string-matching fallbacks
- The Liquid snippet serializes all three metafield keys (size, oven_type, addon_type)
- Theme editor compatibility guard is in place
</success_criteria>

<output>
After completion, create `.planning/phases/02-configurator-stabilization/02-02-SUMMARY.md`
</output>
