---
phase: 02-configurator-stabilization
plan: 04
type: execute
wave: 3
depends_on:
  - "02-03"
files_modified:
  - assets/configurator.js
  - assets/configurator.css
autonomous: true
requirements:
  - CONF-05
  - CONF-06
  - CONF-09

must_haves:
  truths:
    - "A user cannot add to cart with incomplete required steps — a toast message appears"
    - "If the cart add API call fails, the user sees an error message with a retry button"
    - "The final step before cart add shows a grouped summary card with all selections and a single total price"
    - "The configuration summary appears as a line item property in the cart and order confirmation"
  artifacts:
    - path: "assets/configurator.js"
      provides: "Step validation, error recovery, grouped summary builder"
      contains: "_validateRequiredSteps"
    - path: "assets/configurator.css"
      provides: "Toast and summary card styles"
      contains: "cfg-toast"
  key_links:
    - from: "assets/configurator.js _handleAddToCart()"
      to: "assets/configurator.js _validateRequiredSteps()"
      via: "validation called before cart API POST"
      pattern: "_validateRequiredSteps"
    - from: "assets/configurator.js _buildConfigSummary()"
      to: "Shopify Cart AJAX API /cart/add.js"
      via: "summary string sent as line item property 'Configuration'"
      pattern: "Configuration.*_buildConfigSummary"
---

<objective>
Add step validation before cart add with toast messaging, error recovery with retry on cart failures, and a grouped configuration summary that displays on the final step and persists as a cart line item property.

Purpose: Currently a user can attempt cart add with incomplete selections (causing silent failures), cart errors show no retry option, and the order summary is a compact pipe-separated string. This plan makes the cart flow robust and the order information clear.
Output: Validated cart flow, error recovery UX, grouped summary visible in configurator, cart, and order emails.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configurator-stabilization/02-RESEARCH.md
@.planning/phases/02-configurator-stabilization/02-03-SUMMARY.md

@assets/configurator.js
@assets/configurator.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add step validation and toast messaging</name>
  <files>assets/configurator.js, assets/configurator.css</files>
  <action>
**Step validation (CONF-05):**

1. Read `assets/configurator.js` and add a `_validateRequiredSteps()` method. Per user decision, sequential navigation is enforced — users MUST complete the current step before advancing.

2. Define required vs optional steps (Claude's discretion per research):
   - REQUIRED: model_size (step 1), liner (step 2), oven/heating (step 4), exterior (step 5)
   - OPTIONAL (skippable): insulation (step 3), hydro (step 6), air (step 7), filter (step 8), led (step 9), thermometer (step 10), stairs (step 11), pillows (step 12), cover (step 13), controls (step 14), heater_conn (step 15)

3. The validation method should check that all required steps have a selection in `this.state`. Return `{ valid: boolean, missingStep: string | null }`.

4. Call `_validateRequiredSteps()` at the START of `_handleAddToCart()`. If invalid, call `_showToast()` with "Please complete all required selections before adding to cart" and return early — do NOT proceed to the API call.

5. Also enforce sequential navigation in the step advancement logic — when user clicks "Next", check that the current step has a selection if it is required. If not, show toast "Please select an option to continue" (per locked user decision) and prevent advancement.

**Toast messaging:**

6. Add a `_showToast(message, duration = 3000)` method:
```javascript
_showToast(message, duration = 3000) {
  const existing = this.querySelector('.cfg-toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'cfg-toast';
  toast.textContent = message;
  this.appendChild(toast);

  requestAnimationFrame(() => toast.classList.add('cfg-toast--visible'));
  setTimeout(() => {
    toast.classList.remove('cfg-toast--visible');
    toast.addEventListener('transitionend', () => toast.remove(), { once: true });
  }, duration);
}
```

7. Add toast CSS to `assets/configurator.css`:
```css
.cfg-toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(1rem);
  background: var(--color-primary, #262626);
  color: var(--color-background, #F4F1EC);
  padding: 0.75rem 1.5rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
  z-index: 1000;
  pointer-events: none;
  max-width: 90vw;
  text-align: center;
}

.cfg-toast--visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
```
  </action>
  <verify>
- Grep for `_validateRequiredSteps` — method exists in configurator.js
- Grep for `_showToast` — method exists in configurator.js
- Grep for `_validateRequiredSteps` in `_handleAddToCart` — validation is called before cart POST
- Grep for `cfg-toast` in configurator.css — toast styles exist
  </verify>
  <done>Required steps are validated before cart add and before step advancement. Invalid attempts show a toast message. Optional steps can be skipped.</done>
</task>

<task type="auto">
  <name>Task 2: Add error recovery and grouped configuration summary</name>
  <files>assets/configurator.js, assets/configurator.css</files>
  <action>
**Error recovery (CONF-06):**

1. Locate the existing `_showError()` method in `configurator.js`. Replace it with a version that includes a retry button:

```javascript
_showError(msg) {
  if (!this.cartError) return;
  this.cartError.innerHTML = '';

  const msgEl = document.createElement('span');
  msgEl.textContent = msg;

  const retryBtn = document.createElement('button');
  retryBtn.type = 'button';
  retryBtn.className = 'cfg__retry-btn';
  retryBtn.textContent = 'Try again';
  retryBtn.dataset.action = 'retry-cart';

  this.cartError.appendChild(msgEl);
  this.cartError.appendChild(retryBtn);
  this.cartError.style.display = 'flex';
}
```

2. Use `data-action="retry-cart"` on the retry button so the existing event delegation handles it. Add to the click handler in `_bindEvents()`:
```javascript
case 'retry-cart': {
  this._hideError();
  this._handleAddToCart();
  break;
}
```

3. In `_handleAddToCart()`, ensure the error path calls `_showError()` with a descriptive message like "Could not add to cart. Please check your connection and try again."

4. Add CSS for the retry button in `assets/configurator.css`:
```css
.cfg__retry-btn {
  display: inline-block;
  margin-left: 1rem;
  padding: 0.375rem 1rem;
  background: var(--color-accent, #C85E3F);
  color: #fff;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
  font-size: 0.85rem;
}
.cfg__retry-btn:hover {
  opacity: 0.9;
}
```

**Grouped configuration summary (CONF-09):**

5. Locate or create `_buildConfigSummary()`. Replace with a method that produces a GROUPED multi-line summary per locked user decision:

```
Base Model
  {tier name}, Size {size}, {oven type} Oven

Heating
  {oven product title}

Wellness Features
  {hydro product title if selected}
  {air system product title if selected}

Accessories
  {liner title if selected}
  {exterior panel title if selected}
  {cover title if selected}
  {stairs if selected}
  {LED title if selected}
  {pillows if selected}
  {thermometer if selected}
  {filter if selected}

Total: {formatted total}
```

Categories: Base Model, Heating, Wellness Features, Accessories. Only include categories that have selections. Option names only per group — no per-item prices (per locked decision). Single total at bottom.

Summary language must be in English (per locked decision).

6. Use the summary in two places:
   - Display on the final step as a summary card before the "Add to Cart" button
   - Pass as a `'Configuration'` line item property on the base product when adding to cart

7. Keep the summary under 200 bytes (approximately 180 characters to leave a safe margin) to stay within Shopify's cart line item property limit. Use abbreviated labels — truncate long product titles to 20 chars if needed. Omit categories with zero selections from the string entirely. After building the summary string, measure its byte length (`new TextEncoder().encode(summary).length`) and verify it is under 200 bytes for the most complex valid configuration (all categories populated). If it exceeds the limit, further abbreviate category headings (e.g., "Base" instead of "Base Model", "Acc" instead of "Accessories").

8. Add summary card CSS to `assets/configurator.css`:
```css
.cfg-summary {
  background: var(--color-surface, #EDE7DD);
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}
.cfg-summary__group {
  margin-bottom: 0.75rem;
}
.cfg-summary__group:last-child {
  margin-bottom: 0;
}
.cfg-summary__heading {
  font-weight: 600;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.25rem;
  color: var(--color-text-muted, #7D7B78);
}
.cfg-summary__items {
  padding-left: 1rem;
  font-size: 0.9rem;
  line-height: 1.5;
}
.cfg-summary__total {
  margin-top: 1rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--color-text-muted, #7D7B78);
  font-weight: 700;
  font-size: 1.1rem;
}
```
  </action>
  <verify>
- Grep for `_showError` — method contains retry button creation with `data-action="retry-cart"`
- Grep for `retry-cart` in `_bindEvents` — delegated handler exists
- Grep for `_buildConfigSummary` — method exists and produces multi-line grouped output
- Grep for `'Configuration'` property in cart add payload — summary is attached to the base product line item
- Grep for `cfg-summary` in configurator.css — summary card styles exist
- Grep for `cfg__retry-btn` in configurator.css — retry button styles exist
  </verify>
  <done>Cart add failures show error with retry button. Final step displays grouped summary card. Summary persists as cart line item property for order confirmation emails.</done>
</task>

</tasks>

<verification>
1. Try to advance from step 1 without selecting a model — toast "Please select an option to continue" appears
2. Try to add to cart with step 1 incomplete — toast prevents cart add
3. Complete all required steps and add to cart — verify cart contains a "Configuration" property with the grouped summary
4. Simulate a cart add failure (e.g., invalid variant ID) — error message with "Try again" button appears
5. Click "Try again" — the cart add is retried
6. Summary card on final step shows grouped options with category headings and single total at bottom
7. Summary is in English regardless of store locale
</verification>

<success_criteria>
- Required step validation prevents incomplete cart adds with toast feedback
- Cart failures show a retry option that actually retries
- Grouped summary with category headings and single total appears on final step
- Summary stored as 'Configuration' line item property under 200 bytes
- Summary language is English
</success_criteria>

<output>
After completion, create `.planning/phases/02-configurator-stabilization/02-04-SUMMARY.md`
</output>
