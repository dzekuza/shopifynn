---
phase: 06-metafield-resolution-event-delegation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/configurator.js
autonomous: true
requirements:
  - CONF-01
  - CONF-02
  - CONF-03

must_haves:
  truths:
    - "_getSizeFromProduct() and _isInternalOvenProduct() do not exist in configurator.js"
    - "_extractSizes() reads product.meta.size instead of regex on product.title"
    - "_resolveBaseProduct() reads product.meta.oven_type instead of regex on product.title"
    - "Products missing meta.size are skipped with console.warn — not silently included"
    - "If a step has zero valid products after metafield filtering, an error state message is rendered"
    - "connectedCallback does not throw TypeError when [data-configurator-products] element is absent"
    - "Theme editor shows a branded placeholder instead of a broken configurator"
    - "_showVariants() does not call addEventListener — variant clicks are handled via _bindEvents delegation"
    - "_updateGallery() does not call addEventListener — gallery clicks are handled via _bindEvents delegation"
  artifacts:
    - path: "assets/configurator.js"
      provides: "Metafield-based product resolution, connectedCallback guard, event delegation"
      contains: "product.meta?.size"
  key_links:
    - from: "assets/configurator.js _extractSizes()"
      to: "product.meta.size"
      via: "direct property read"
      pattern: "meta\\?\\.size"
    - from: "assets/configurator.js _resolveBaseProduct()"
      to: "product.meta.oven_type"
      via: "direct property read"
      pattern: "meta\\?\\.oven_type"
    - from: "assets/configurator.js _bindEvents()"
      to: "select-variant action handler"
      via: "event delegation switch case"
      pattern: "case 'select-variant'"
---

<objective>
Replace fragile regex-based product title matching with metafield data reads, add a connectedCallback null guard with branded placeholder, and convert per-element event listeners to delegation via _bindEvents.

Purpose: Eliminate product resolution fragility (titles can change, metafields are structured data), prevent TypeError in Shopify theme editor, and fix listener accumulation on step re-visits.
Output: Updated assets/configurator.js with metafield resolution, editor guard, and delegated events.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-metafield-resolution-event-delegation/06-RESEARCH.md
@assets/configurator.js
@snippets/configurator-product-json.liquid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace regex product matching with metafield reads, add connectedCallback guard</name>
  <files>assets/configurator.js</files>
  <action>
Three changes in configurator.js:

**1. connectedCallback null guard (line ~42):**

Replace the current unconditional `this.data = JSON.parse(this.querySelector(...)` with:

```javascript
connectedCallback() {
  const dataEl = this.querySelector('[data-configurator-products]');
  if (!dataEl) {
    this._renderEditorPlaceholder();
    return;
  }
  this.data = JSON.parse(dataEl.textContent);
  // ... rest of initialization unchanged
}
```

Add a `_renderEditorPlaceholder()` method (place it in the LIFECYCLE section, after connectedCallback):
- Renders a branded placeholder div inside `this.innerHTML`
- Uses CSS variables: `var(--font-heading)`, `var(--font-body)`, `var(--color-surface, #EDE7DD)`, `var(--color-primary, #262626)`, `var(--color-text-muted, #7D7B78)`
- Heading: "Hot Tub Configurator" in 22px heading font
- Body: A message that the configurator preview isn't available in the theme editor, mentioning collection assignment
- Centered layout, min-height 400px, 12px border-radius, subtle border
- Use `this.innerHTML = ...` — safe here because if dataEl is null, there's nothing to preserve

**2. Replace _extractSizes (line ~808+) to read meta.size instead of calling _getSizeFromProduct:**

```javascript
_extractSizes(products) {
  const sizeMap = new Map();
  const sizeOrder = ['XL', 'L', 'M'];

  for (const p of products) {
    const size = (p.meta?.size || '').toUpperCase();
    if (!size) {
      console.warn('[Configurator] Product missing meta.size — skipping:', p.title);
      continue;
    }
    if (!sizeMap.has(size)) {
      sizeMap.set(size, { key: size.toLowerCase(), label: size, minPrice: p.price, products: [] });
    }
    const entry = sizeMap.get(size);
    entry.products.push(p);
    if (p.price < entry.minPrice) entry.minPrice = p.price;
  }

  if (sizeMap.size === 0) {
    this._renderProductError('No sizes available for this model. Please check product metafield configuration.');
  }

  return sizeOrder.filter(s => sizeMap.has(s)).map(s => sizeMap.get(s));
}
```

Add a `_renderProductError(message)` method in the UI UTILITIES section that renders a visible error message inside the current step body. This should be styled distinctly (use Aurowe terracotta accent `var(--color-accent, #C85E3F)`) so an admin would notice the data issue. Render into the current active step's body or a dedicated error area.

**3. Replace _resolveBaseProduct to read meta.size and meta.oven_type instead of calling the regex methods:**

In _resolveBaseProduct (line ~830+), replace all 4 call sites:
- Line 837: `this._getSizeFromProduct(p) === size && this._isInternalOvenProduct(p) === wantInternal` → filter using `(p.meta?.size || '').toUpperCase() === size` and check `(p.meta?.oven_type || '').toLowerCase()` against `'internal'` or `'external'`
- Line 843: same pattern for fallback branch
- Line 875 in `_updateOvenAvailability`: `this._getSizeFromProduct(p) === size && this._isInternalOvenProduct(p)` → same metafield reads

Use `'internal'` and `'external'` as the oven_type values (per setup-configurator.mjs convention).

**4. Delete `_getSizeFromProduct` (lines 795-801) and `_isInternalOvenProduct` (lines 803-806) entirely.**

CONF-03 requires deletion in the same commit as the metafield migration. Do a global search to confirm no remaining call sites before deleting.

**Important:** No regex fallback — metafields are the only resolution path. Products without metafields are skipped (per locked decision).
  </action>
  <verify>
Search configurator.js for any remaining references to `_getSizeFromProduct` or `_isInternalOvenProduct` — zero results expected.
Search for `regex` or `/\\b` patterns in size/oven resolution methods — none should remain.
Verify `connectedCallback` has the null guard: grep for `if (!dataEl)`.
Verify `_renderEditorPlaceholder` method exists.
Verify `_renderProductError` method exists.
Verify `_extractSizes` reads `p.meta?.size`.
  </verify>
  <done>
_getSizeFromProduct() and _isInternalOvenProduct() are deleted. All 4 call sites replaced with direct meta.size and meta.oven_type reads. connectedCallback gracefully handles missing data element with branded placeholder. Zero-product error state renders a visible message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert _showVariants and _updateGallery listeners to event delegation</name>
  <files>assets/configurator.js</files>
  <action>
Two listener accumulation fixes:

**1. Move variant selection from _showVariants() to _bindEvents():**

In `_showVariants()` (line ~432), remove the `target.addEventListener('click', (e) => { ... })` block entirely. The variant click handling moves to the existing `_bindEvents()` switch on `data-action`.

Add a new case in the `_bindEvents()` click handler switch statement:

```javascript
case 'select-variant': {
  const group = target.dataset.group;
  const container = target.parentElement;
  if (container) {
    container.querySelectorAll('.cfg-swatch--selected, .cfg-pill--selected').forEach(s => {
      s.classList.remove('cfg-swatch--selected', 'cfg-pill--selected');
      s.setAttribute('aria-pressed', 'false');
    });
  }
  target.classList.add(
    target.classList.contains('cfg-swatch') ? 'cfg-swatch--selected' : 'cfg-pill--selected'
  );
  target.setAttribute('aria-pressed', 'true');
  this._selectVariant(group, parseInt(target.dataset.variantId), parseInt(target.dataset.price));
  break;
}
```

Ensure the variant swatch/pill elements rendered by _showVariants() already have `data-action="select-variant"` attributes. If they don't, add `data-action="select-variant"` to the HTML template strings that create `.cfg-swatch` and `.cfg-pill` elements inside _showVariants().

**2. Move gallery thumbnail click from _updateGallery() to _bindEvents():**

In `_updateGallery()` (line ~1597), remove the `this.gallery.addEventListener('click', ...)` block. This is the genuine listener accumulation bug — `this.gallery` is a cached element reference, so each call to _updateGallery adds another listener.

Add `data-action="select-thumb"` and `data-thumb-idx="${i}"` attributes to each `.cfg-thumb` element in the _updateGallery() HTML template.

Store the current gallery images as an instance property: `this._currentGalleryImages = images;` in _updateGallery() so the delegation handler can access them.

Add a new case in _bindEvents():

```javascript
case 'select-thumb': {
  const idx = parseInt(target.dataset.thumbIdx);
  this.gallery?.querySelectorAll('.cfg-thumb').forEach((t, i) =>
    t.classList.toggle('cfg-thumb--active', i === idx)
  );
  const images = this._currentGalleryImages || [];
  if (images[idx]) {
    this._preloadImage(images[idx].src);
    this._setMainImage(images[idx].src);
  }
  break;
}
```

**Do NOT touch** the main `this.addEventListener('click', ...)` or `this.addEventListener('keydown', ...)` in _bindEvents() — those are already correctly delegated. Also do NOT touch the `card.addEventListener('click', ...)` on line 1243 unless you confirm it causes listener accumulation (it likely doesn't if cards are recreated via innerHTML each time).
  </action>
  <verify>
Search for `addEventListener` in configurator.js — verify that _showVariants and _updateGallery no longer contain addEventListener calls.
Verify `case 'select-variant':` exists in _bindEvents switch.
Verify `case 'select-thumb':` exists in _bindEvents switch.
Verify `this._currentGalleryImages` is assigned in _updateGallery.
Verify swatch/pill elements have `data-action="select-variant"` in their HTML templates.
Verify thumb elements have `data-action="select-thumb"` in their HTML templates.
  </verify>
  <done>
_showVariants() no longer attaches event listeners — variant clicks delegated to _bindEvents via 'select-variant' case. _updateGallery() no longer attaches event listeners — gallery clicks delegated via 'select-thumb' case. No listener accumulation on step re-visits or gallery updates.
  </done>
</task>

</tasks>

<verification>
1. `grep -c '_getSizeFromProduct\|_isInternalOvenProduct' assets/configurator.js` returns 0
2. `grep -c 'meta?.size' assets/configurator.js` returns at least 3 (extractSizes, resolveBaseProduct, updateOvenAvailability)
3. `grep -c 'meta?.oven_type' assets/configurator.js` returns at least 2
4. `grep -c '_renderEditorPlaceholder' assets/configurator.js` returns at least 2 (definition + call)
5. `grep -c "case 'select-variant'" assets/configurator.js` returns 1
6. `grep -c "case 'select-thumb'" assets/configurator.js` returns 1
7. In _showVariants, no `addEventListener` call remains
8. In _updateGallery, no `addEventListener` call remains
</verification>

<success_criteria>
- Regex-based product title matching is completely eliminated — only metafield reads remain
- connectedCallback is safe in Shopify theme editor — branded placeholder shown instead of TypeError
- Event delegation prevents listener accumulation on step re-visits and gallery updates
- Products without metafields are skipped with console warnings
- Zero-product steps show a visible error state
</success_criteria>

<output>
After completion, create `.planning/phases/06-metafield-resolution-event-delegation/06-01-SUMMARY.md`
</output>
