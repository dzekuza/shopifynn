---
phase: 01-security-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - sections/configurator.liquid
  - assets/configurator.js
autonomous: false
requirements:
  - SEC-04
  - SEC-05
  - SEC-06

must_haves:
  truths:
    - "DOMPurify 3.2.7 loads from jsDelivr CDN on the configurator page before configurator.js executes"
    - "All innerHTML assignments with external product data are sanitized through DOMPurify.sanitize()"
    - "The _escAttr() method is deleted from the codebase"
    - "The configurator renders all 15 steps correctly after sanitization — no stripped data-* attributes or broken HTML"
    - "Static innerHTML assignments (no external data) are left untouched — no unnecessary DOMPurify overhead"
  artifacts:
    - path: "sections/configurator.liquid"
      provides: "DOMPurify CDN script tag loaded before configurator.js"
      contains: "dompurify@3.2.7"
    - path: "assets/configurator.js"
      provides: "Sanitized innerHTML assignments, no _escAttr method"
      contains: "DOMPurify.sanitize"
  key_links:
    - from: "sections/configurator.liquid"
      to: "assets/configurator.js"
      via: "DOMPurify global available via defer script ordering"
      pattern: "dompurify.*defer.*configurator\\.js.*defer"
    - from: "assets/configurator.js"
      to: "DOMPurify global"
      via: "DOMPurify.sanitize() calls before innerHTML assignment"
      pattern: "DOMPurify\\.sanitize"
---

<objective>
Eliminate all XSS vectors in the configurator by loading DOMPurify and sanitizing innerHTML assignments.

Purpose: Defense-in-depth protection for all innerHTML call sites that render product data from Shopify Admin JSON. While the data source is trusted (admin-only), sanitization prevents XSS if data is ever compromised or if the pattern is copied to user-input contexts.

Output: DOMPurify loaded on configurator page, all 16 innerHTML call sites reviewed and sanitized appropriately, _escAttr() deleted.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-CONTEXT.md
@.planning/phases/01-security-foundation/01-RESEARCH.md
@sections/configurator.liquid
@assets/configurator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Load DOMPurify and sanitize all innerHTML call sites</name>
  <files>sections/configurator.liquid, assets/configurator.js</files>
  <action>
**Part A — Load DOMPurify in configurator.liquid (SEC-05):**

In `sections/configurator.liquid`, add a DOMPurify script tag immediately BEFORE the existing configurator.js script tag (around line 453). Both must use `defer` to guarantee execution order:

```liquid
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.7/dist/purify.min.js" defer></script>
<script src="{{ 'configurator.js' | asset_url }}" defer></script>
```

If there is already a configurator.js script tag, place DOMPurify immediately before it. Do NOT use `async` — `defer` preserves DOM order execution.

**Part B — Sanitize innerHTML call sites in configurator.js (SEC-04):**

Read configurator.js and identify all innerHTML assignment sites. Apply the following mixed strategy based on what each site renders:

1. **Complex HTML blocks with product data** (template literals containing product titles, images, prices from Shopify JSON): Wrap in `DOMPurify.sanitize()` before assignment.
   ```javascript
   // BEFORE:
   container.innerHTML = html;
   // AFTER:
   container.innerHTML = DOMPurify.sanitize(html);
   ```

2. **Static error/placeholder strings** (hardcoded HTML with NO external data, e.g., `'<p class="cfg-empty">Not configured.</p>'`): Leave as-is. No sanitization needed — these are safe string literals.

3. **Summary list items built from state strings** (~line 959): Replace innerHTML with DOM builder approach using `document.createElement()` + `textContent`:
   ```javascript
   this.summaryList.replaceChildren(
     ...items.map(text => {
       const li = document.createElement('li');
       li.className = 'cfg-summary-item';
       li.textContent = text;
       return li;
     })
   );
   ```

**Part C — Delete _escAttr() and update its call sites (SEC-06):**

1. Find the `_escAttr()` method definition (~line 1163) and delete it entirely.

2. Find the 3 call sites that use `_escAttr()` (~lines 177, 225, 322) — these build tooltip buttons with `data-tooltip="${this._escAttr(tooltip)}"`. Replace with just `${tooltip}` in the template literal (removing the `this._escAttr()` wrapper). The DOMPurify.sanitize() call on the outer HTML block will handle sanitization of the attribute value.

**Classification reference from research (verify against actual line numbers):**

| Line(s) | Content | Strategy |
|---------|---------|----------|
| 150, 203, 329 | Complex HTML with labels/images/spans | DOMPurify.sanitize() |
| 157, 211, 265 | Static error strings | Leave as-is |
| 216, 233, 271, 336, 341 | Template literals with product data | DOMPurify.sanitize() |
| 667 | Size card HTML from hardcoded dims/persons | DOMPurify.sanitize() for consistency |
| 765, 771 | Variant swatches/pills | DOMPurify.sanitize() |
| 959 | Summary list items | DOM builder with textContent |
| 983 | Gallery thumbs with image URLs | DOMPurify.sanitize() |

NOTE: Line numbers are approximate from research. Read the actual file and locate each innerHTML assignment. The strategy (sanitize vs leave vs DOM builder) depends on whether external data flows into the HTML string.
  </action>
  <verify>
- `grep -c "DOMPurify.sanitize" assets/configurator.js` returns >= 10 (most innerHTML sites sanitized)
- `grep "_escAttr" assets/configurator.js` returns 0 (method and all call sites removed)
- `grep "dompurify@3.2.7" sections/configurator.liquid` returns a match
- `grep -c "innerHTML" assets/configurator.js` — count should remain similar (innerHTML is still used, but with DOMPurify.sanitize() wrapping)
- Verify DOMPurify script tag appears BEFORE configurator.js script tag in configurator.liquid
  </verify>
  <done>
- DOMPurify 3.2.7 CDN script tag in configurator.liquid, before configurator.js, both using defer
- All innerHTML sites with external product data wrapped in DOMPurify.sanitize()
- Static innerHTML strings left untouched (no unnecessary overhead)
- Summary list uses DOM builder with textContent instead of innerHTML
- _escAttr() method deleted, its 3 call sites updated to rely on DOMPurify
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify configurator renders correctly after sanitization</name>
  <files>sections/configurator.liquid, assets/configurator.js</files>
  <action>
Present the configurator to the user for manual spot-check. Run `shopify theme dev` if not already running. The user will verify that DOMPurify integration has not broken any configurator rendering.

What was built: DOMPurify integration and innerHTML sanitization across all 16 call sites in configurator.js. The _escAttr() custom sanitizer has been removed and replaced with DOMPurify.sanitize(). The summary list now uses DOM builder APIs instead of innerHTML.

Steps for user verification:
1. Run `shopify theme dev` to start the local development server
2. Navigate to the configurator page (typically /pages/configurator)
3. Walk through the first 3-4 steps of the configurator:
   - Step 1: Select a model tier (Classic/Premium/Signature) — verify cards render with images, titles, and prices
   - Step 2: Select a size — verify size cards show dimensions and capacity
   - Step 3-4: Select options — verify option cards render correctly with images and labels
4. Check that tooltip buttons (the "?" icons) still work — hover/click should show tooltip text
5. Open browser DevTools console — verify NO errors like "DOMPurify is not defined" or "TypeError: Cannot read properties"
6. Check the configuration summary panel (if visible) — verify it lists selected options correctly
7. If any option cards appear blank, have missing data-* attributes, or don't respond to clicks, report the specific step and card
  </action>
  <verify>User confirms configurator renders correctly with no visual regression and no console errors.</verify>
  <done>User has approved that all configurator steps render identically to the pre-change state. No stripped data-* attributes, no broken HTML, no missing images or labels.</done>
</task>

</tasks>

<verification>
1. DOMPurify 3.2.7 loads on configurator page (check network tab in DevTools)
2. No `_escAttr` references anywhere in configurator.js
3. `DOMPurify.sanitize()` wraps all innerHTML assignments that contain product data
4. Static innerHTML strings are NOT wrapped (verify by checking the static error message strings)
5. Configurator steps render correctly — user spot-check confirms no visual regression
</verification>

<success_criteria>
- DOMPurify 3.2.7 loads from jsDelivr CDN before configurator.js on the configurator page
- All innerHTML call sites with external data are sanitized
- _escAttr() is fully removed from the codebase
- Configurator renders identically to pre-change state (user-verified)
- No JavaScript console errors on the configurator page
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-02-SUMMARY.md`
</output>
