---
phase: 01-security-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .gitignore
  - .env.example
  - scripts/setup-configurator.mjs
  - scripts/fix-collections.mjs
  - assets/theme.js
autonomous: true
requirements:
  - SEC-01
  - SEC-02
  - SEC-03
  - ARCH-04

must_haves:
  truths:
    - "A local mirror backup of the repo exists before any history analysis or rewriting"
    - "git log -p across all commits contains no credential values (CLIENT_ID, CLIENT_SECRET, API keys)"
    - ".env is listed in .gitignore — git will never track it"
    - ".env.example documents all required environment variables with placeholder values"
    - "Both setup scripts read credentials from process.env and exit with clear error if missing"
    - "No hardcoded CLIENT_ID, CLIENT_SECRET, or API key values exist in any source file"
    - "theme.js contains zero var declarations — only const and let"
  artifacts:
    - path: ".gitignore"
      provides: "Git ignore rules including .env"
      contains: ".env"
    - path: ".env.example"
      provides: "Credential placeholder documentation"
      contains: "SHOPIFY_CLIENT_ID"
    - path: "scripts/setup-configurator.mjs"
      provides: "Configurator setup script reading from process.env"
      contains: "process.env.SHOPIFY_CLIENT_ID"
    - path: "scripts/fix-collections.mjs"
      provides: "Collection fix script reading from process.env"
      contains: "process.env.SHOPIFY_CLIENT_ID"
    - path: "assets/theme.js"
      provides: "Modernized JS with const/let only"
  key_links:
    - from: "scripts/setup-configurator.mjs"
      to: ".env.example"
      via: "Environment variable names match"
      pattern: "SHOPIFY_CLIENT_ID|SHOPIFY_CLIENT_SECRET"
    - from: "scripts/fix-collections.mjs"
      to: ".env.example"
      via: "Environment variable names match"
      pattern: "SHOPIFY_CLIENT_ID|SHOPIFY_CLIENT_SECRET"
---

<objective>
Secure credential management and modernize theme.js variable declarations.

Purpose: Prevent credentials from ever being committed to git, ensure setup scripts read secrets from environment variables only, and eliminate var declarations in theme.js for consistent modern JavaScript.

Output: .gitignore with .env entry, .env.example with placeholders, refactored setup scripts using process.env, theme.js with const/let only.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-CONTEXT.md
@.planning/phases/01-security-foundation/01-RESEARCH.md
@scripts/setup-configurator.mjs
@scripts/fix-collections.mjs
@assets/theme.js
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backup repo and verify git history is credential-free (SEC-02)</name>
  <files>(no files modified — this is a verification/remediation task)</files>
  <action>
**Step 1 — Create local backup clone (locked decision from CONTEXT.md):**

Run `git clone --mirror . ../shopifynn-backup-$(date +%Y%m%d)` to create a full mirror backup of the repository before any history analysis or potential rewriting. This is a non-negotiable prerequisite — the backup must exist before proceeding.

Verify the backup exists: `ls -d ../shopifynn-backup-*`

**Step 2 — Scan full git history for leaked credentials:**

Run a comprehensive search across ALL committed content:
```bash
git log -p --all -- ':(exclude).env' | grep -E "shpss_|ed27735|CLIENT_ID\s*=\s*['\"][^'\"]+['\"]|CLIENT_SECRET\s*=\s*['\"][^'\"]+['\"]|SHOPIFY_API_KEY\s*=\s*['\"][^'\"]+['\"]" || echo "CLEAN: No credentials found in git history"
```

Also check for any .env file that may have been committed and removed:
```bash
git log --all --diff-filter=D -- .env
git log --all -- .env
```

**Step 3 — Act on results:**

- **If NO matches found:** Document this explicitly in the SUMMARY. The rationale is: scripts were never committed (confirmed `??` untracked status), and no other files contained credential values. SEC-02 is satisfied by verification, not by rewriting.

- **If matches ARE found:** Execute git-filter-repo to purge them:
  1. Install git-filter-repo: `pip3 install git-filter-repo` (or `brew install git-filter-repo`)
  2. Run: `git filter-repo --invert-grep --message-callback 'return message' --blob-callback '...'` targeting the specific credential patterns
  3. After rewrite, re-run the Step 2 scan to confirm zero matches
  4. Force-push is acceptable per CONTEXT.md (solo developer)

Either path produces a verified-clean history.
  </action>
  <verify>
- `ls -d ../shopifynn-backup-*` confirms backup clone exists
- `git log -p --all -- ':(exclude).env' | grep -cE "shpss_|ed27735" || echo 0` returns 0
- `git log --all -- .env | wc -l` returns 0 (no .env was ever committed)
  </verify>
  <done>
- Local mirror backup exists at ../shopifynn-backup-YYYYMMDD
- Git history has been scanned across ALL tracked files and ALL commits
- Either: history confirmed clean (documented rationale) OR credentials purged via git-filter-repo
- `git log -p` contains no CLIENT_ID, CLIENT_SECRET, or API key values (Phase 1 Success Criterion #1)
  </done>
</task>

<task type="auto">
  <name>Task 2: Secure credential management and .gitignore</name>
  <files>.gitignore, .env.example, scripts/setup-configurator.mjs, scripts/fix-collections.mjs</files>
  <action>
1. Add `.env` entry to `.gitignore`. If `.gitignore` doesn't exist, create it with just the `.env` line plus standard Shopify theme ignores. Add under a "# Environment secrets" comment.

2. Create `.env.example` with placeholder values documenting required variables:
```
# Shopify API credentials for setup scripts
# Copy this file to .env and fill in your values
SHOPIFY_CLIENT_ID=your_client_id_here
SHOPIFY_CLIENT_SECRET=your_client_secret_here
SHOPIFY_API_KEY=your_api_key_here
SHOPIFY_API_VERSION=2024-10
```

3. Refactor `scripts/setup-configurator.mjs`:
   - Replace hardcoded CLIENT_ID and CLIENT_SECRET constants with `process.env.SHOPIFY_CLIENT_ID` and `process.env.SHOPIFY_CLIENT_SECRET`
   - Keep STORE as hardcoded `'aurowe-2.myshopify.com'` (not a secret) OR read from `process.env.SHOPIFY_STORE` with that default
   - Add validation at the top of the script: if CLIENT_ID or CLIENT_SECRET are missing, print clear error message referencing .env.example and call `process.exit(1)`
   - Keep the API_VERSION as `process.env.SHOPIFY_API_VERSION || '2024-10'`

4. Refactor `scripts/fix-collections.mjs` with the exact same credential pattern as setup-configurator.mjs. Both scripts must use identical environment variable names and validation logic.

SEC-01 note: Credentials were already rotated on the Shopify admin side per user confirmation. No code action needed — just ensure old values are removed from scripts.

SEC-02 note: Git history verification is handled by Task 1. This task focuses on preventing future credential exposure by removing hardcoded values from scripts.
  </action>
  <verify>
- `grep -r "shpss_\|ed27735\|CLIENT_ID.*=.*'" scripts/` returns no hardcoded credential values (only process.env references)
- `grep ".env" .gitignore` shows .env is listed
- `.env.example` exists with placeholder values
- `grep "process.env.SHOPIFY_CLIENT_ID" scripts/setup-configurator.mjs` returns a match
- `grep "process.env.SHOPIFY_CLIENT_ID" scripts/fix-collections.mjs` returns a match
- `grep "process.exit(1)" scripts/setup-configurator.mjs` confirms validation exists
  </verify>
  <done>
- .env is in .gitignore
- .env.example exists with all required variable placeholders
- Both setup scripts read CLIENT_ID and CLIENT_SECRET from process.env
- Both scripts exit with clear error if credentials are missing
- No hardcoded credential values remain in any source file
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate all var declarations to const/let in theme.js</name>
  <files>assets/theme.js</files>
  <action>
Replace all ~40 `var` declarations in `assets/theme.js` with `const` or `let`:

**Decision rule:**
- `const` if the binding is never reassigned after its declaration (DOM query results, event handler references, computed values assigned once)
- `let` if the binding is reassigned anywhere after declaration (counters like `currentIndex`, touch tracking like `touchStartX`, loop variables like `for (var i = ...)`)

**Specific known cases from research (verify against actual code):**
- Gallery DOM queries → `const` (never reassigned): `gallery`, `slides`, `prevBtn`, `nextBtn`, `dots`, `galleryImages`
- State/counter variables → `let` (reassigned): `currentIndex`, `touchStartX`, `scrollTimeout`
- Loop variables → `let`: `for (let i = 0; ...)`
- Block-scoped computed values → `const`: `diff`, `totalSlides`, `direction`

**Process:**
1. Read theme.js fully
2. For each `var` declaration, search for reassignment of that variable name (look for `variableName =` without `var`/`let`/`const` prefix later in the same scope)
3. If reassigned → `let`; if never reassigned → `const`
4. Replace all occurrences

**Critical: Do NOT mechanically replace all var with const.** Each declaration needs individual analysis of whether it's reassigned. A wrong const on a reassigned variable causes a runtime TypeError.

The file is inside an IIFE with 'use strict' — all var declarations are function-scoped. Block scoping from let/const aligns correctly since the code doesn't rely on var hoisting across blocks.
  </action>
  <verify>
- `grep -c "^[[:space:]]*var " assets/theme.js` returns 0 (no var declarations remain)
- `grep -c "const \|let " assets/theme.js` returns >= 40 (all replaced)
- Open the store in a browser or run `shopify theme dev` and verify: sticky header works, mobile menu toggles, dropdown menus open/close, product gallery navigates. No console errors related to const reassignment.
  </verify>
  <done>
- Zero var declarations in theme.js
- All replaced with appropriate const or let based on reassignment analysis
- No runtime errors from incorrect const assignment to reassigned variables
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "shpss_\|ed27735" scripts/` — zero matches (no hardcoded credentials)
2. `grep ".env" .gitignore` — .env is listed
3. `cat .env.example` — shows placeholder variable documentation
4. `grep -c "var " assets/theme.js` — zero (accounting for var inside strings/comments is acceptable)
5. No new files created except .env.example and .gitignore modifications
</verification>

<success_criteria>
- Credential management is production-safe: .env ignored, scripts read from environment, clear errors on missing vars
- theme.js is fully modernized: const/let only, no var declarations
- No functionality regressions in theme.js interactive features
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-01-SUMMARY.md`
</output>
