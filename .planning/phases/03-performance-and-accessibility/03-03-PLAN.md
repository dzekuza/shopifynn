---
phase: 03-performance-and-accessibility
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/configurator.js
  - sections/configurator.liquid
autonomous: true
requirements:
  - PERF-01
  - PERF-04
  - A11Y-01
  - A11Y-02
  - A11Y-04

must_haves:
  truths:
    - "Navigating between configurator steps does not cause a visible image flash — the next image is preloaded before the transition"
    - "A keyboard-only user can complete all 15 configurator steps without requiring a mouse"
    - "Screen reader announces step number, option names, and selection state for every interactive configurator element"
    - "All interactive touch targets in the configurator are at minimum 44x44px on mobile"
    - "Locked steps are not keyboard-focusable — tab order skips locked step body content"
  artifacts:
    - path: "assets/configurator.js"
      provides: "Image preloading, DOM caching, ARIA management, keyboard navigation, inert attribute management"
      contains: "_preloadImage"
    - path: "sections/configurator.liquid"
      provides: "ARIA roles, labels, and inert attributes on step markup"
      contains: "role=\"group\""
  key_links:
    - from: "assets/configurator.js"
      to: "sections/configurator.liquid"
      via: "_unlockThrough() manages aria-disabled and inert attributes on step elements rendered by the Liquid template"
      pattern: "aria-disabled"
    - from: "assets/configurator.js"
      to: "Image preload cache"
      via: "_preloadImage() fires before _setMainImage() to ensure image is in browser cache"
      pattern: "_preloadImage"
    - from: "sections/configurator.liquid"
      to: "Screen reader accessibility tree"
      via: "role=group + aria-labelledby on each step div provides step structure to assistive technology"
      pattern: "aria-labelledby"
---

<objective>
Add image preloading and DOM caching to the configurator for smooth transitions, and implement full ARIA semantics, keyboard navigation, and accessible touch targets.

Purpose: Make the configurator performant on real devices (no image flash between steps) and fully operable by keyboard-only users and screen reader users, meeting WCAG 2.1 AA.
Output: Updated configurator.js with preloading, caching, ARIA management, and keyboard nav. Updated configurator.liquid with semantic ARIA markup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-performance-and-accessibility/3-RESEARCH.md
@assets/configurator.js
@sections/configurator.liquid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image preloading and expand DOM caching in configurator</name>
  <files>assets/configurator.js</files>
  <action>
**Image preloading (PERF-01):**

Add a `_preloadImage(url)` method to the `HotTubConfigurator` class that returns a Promise:
```javascript
_preloadImage(url) {
  return new Promise((resolve) => {
    if (!url) { resolve(); return; }
    const img = new Image();
    img.onload = resolve;
    img.onerror = resolve; // resolve on error too — don't block UI
    img.src = url;
  });
}
```

Integrate preloading into step transition flows. Find every call site where `_setMainImage(url)` is called (model select, size select, option changes that update the preview image). Before each `_setMainImage` call, fire `this._preloadImage(url)` as a non-blocking fire-and-forget call. The preload starts the browser fetch; by the time the 120ms fade transition in `_setMainImage` completes, the image should be cached.

Specifically:
- In `_handleModelSelect()`: preload `tier.image` before setting it
- In `_handleSizeSelect()`: preload the size-specific image if one exists
- In any handler that updates the main preview image: preload first

For step transitions (navigating from step N to step N+1), preload the default image for the next step when the current step's selection is made. This requires knowing the next step's default image URL from the product JSON data.

**DOM caching expansion (PERF-04):**

Audit the existing `_cacheEls()` method. It likely caches some commonly-accessed DOM nodes. Identify nodes that are queried repeatedly on every action (e.g., via `this.querySelector()` calls in handlers) but NOT already cached. Add them to `_cacheEls()`.

Common candidates for caching:
- The main image element (if not already cached)
- The price total display element
- The summary list container
- The CTA/add-to-cart button
- Step container elements (`[data-step="N"]` for each step)
- The image loader/spinner element

Store cached elements as `this._els.mainImage`, `this._els.priceTotal`, etc. (or whatever naming pattern `_cacheEls` already uses — follow existing convention).

Replace repeated `this.querySelector(...)` calls in frequently-called methods with cached references. Do NOT cache elements that are dynamically created/destroyed during step rendering.
  </action>
  <verify>
Grep configurator.js for `_preloadImage` — should exist as a method definition.
Grep configurator.js for `_preloadImage(` — should appear in at least 2-3 call sites (model select, size select, etc.).
Grep configurator.js for `_cacheEls` — should show expanded caching.
Count `this.querySelector` calls — should be reduced compared to before (fewer ad-hoc queries in hot paths).
  </verify>
  <done>Image preloading fires before every main image transition. DOM nodes used in hot paths are cached in _cacheEls(). The configurator image swap is smooth with no visible loading flash.</done>
</task>

<task type="auto">
  <name>Task 2: Add ARIA semantics, keyboard navigation, and touch target sizing</name>
  <files>sections/configurator.liquid, assets/configurator.js</files>
  <action>
**ARIA labels and roles (A11Y-01):**

In `sections/configurator.liquid`, update the step loop markup:
1. Add `role="group"` to each step container div (`[data-step="N"]`)
2. Add `id="cfg-step-title-{{ i }}"` to each step's `<h3>` title element
3. Add `aria-labelledby="cfg-step-title-{{ i }}"` to each step container
4. Add `aria-disabled="true"` to locked steps (steps where `i > 1` on initial render)
5. Add `aria-hidden="true"` to the step badge `<span>` (the number badge is decorative — the title provides the accessible name)
6. Wrap each step's interactive body content in a container with the `inert` attribute when locked:
   - Add a wrapper `<div class="cfg-step__body" {% if i > 1 %}inert{% endif %}>` around the step content area (below the header, above the step footer if any)
   - IMPORTANT: Apply `inert` only to the body, NOT the header — the step title should remain readable by screen readers even when locked

In `assets/configurator.js`, update `_unlockThrough()`:
1. When unlocking a step, remove `inert` from its `.cfg-step__body` and set `aria-disabled="false"` on the step container
2. When a step stays locked, ensure `inert` is present on `.cfg-step__body` and `aria-disabled="true"` on the container
3. After unlocking a new step, move focus to the first focusable element inside the newly unlocked step (or the step header's title)

Fix JS-generated ARIA gaps identified in research:
- Oven type toggle buttons: add `aria-pressed` on initial render (not just on interaction)
- Qty buttons (minus/plus): add `aria-label="Decrease quantity"` and `aria-label="Increase quantity"`
- Add `aria-live="polite"` to the price total container so price changes are announced

**Keyboard navigation (A11Y-02):**

1. Verify the existing Enter/Space keydown handler covers all `[data-action]` elements
2. For locked steps: the `inert` attribute on `.cfg-step__body` automatically removes children from tab order — no additional tabindex management needed
3. After step unlock + focus move (from ARIA task above), verify tab flows naturally through the new step's interactive elements
4. For radio-group style options (liner, exterior panels, etc.): if they use hidden `<input type="radio">` elements, verify arrow key navigation works natively. If they use custom `[data-action]` divs, add arrow key support:
   - Left/Up arrow moves to previous option
   - Right/Down arrow moves to next option
   - Selection wraps at boundaries
5. Ensure the "Add to Cart" button is keyboard-accessible and has a clear focus indicator

**Touch target sizing (A11Y-04):**

In `sections/configurator.liquid` `{% stylesheet %}` block (or `assets/theme.css` if configurator CSS has been extracted by Phase 2):
1. `.cfg-qty-btn`: Change from `width: 40px; height: 40px` to `width: 44px; height: 44px`
2. `.cfg-tooltip-btn`: Expand hit area without changing visual size. Add `min-width: 44px; min-height: 44px;` or use padding approach: `padding: 12px; box-sizing: content-box;` to expand the 20x20px visual to a 44x44px touch area
3. Audit other interactive elements (swatches, pills, card selections) — ensure they meet 44x44px minimum. If any are smaller, increase their min-width/min-height

Note: If configurator CSS is still embedded in `{% stylesheet %}` (Phase 2 may have extracted it to assets/configurator.css), make changes in whichever location the styles currently live.
  </action>
  <verify>
Open sections/configurator.liquid and verify:
- Each step div has `role="group"` and `aria-labelledby`
- Step titles have `id` attributes matching the aria-labelledby references
- Locked steps have `aria-disabled="true"` and their body has `inert`

Grep configurator.js for:
- `aria-disabled` — should appear in _unlockThrough()
- `inert` — should appear in _unlockThrough()
- `.focus()` — should appear after unlock logic
- `aria-label` — should appear for qty buttons
- `aria-pressed` — should appear for oven type toggles on render

Check CSS for:
- `.cfg-qty-btn` has width/height >= 44px
- `.cfg-tooltip-btn` has min-width/min-height >= 44px (or equivalent padding approach)
  </verify>
  <done>Every configurator step has ARIA role="group" with labeled semantics. Locked steps are inert (not keyboard-focusable). Unlocking a step moves focus to it. All interactive elements have appropriate ARIA attributes. Keyboard users can navigate all options with Tab, Enter/Space, and arrow keys. All touch targets meet 44x44px minimum.</done>
</task>

</tasks>

<verification>
1. Every `[data-step]` div has `role="group"` and `aria-labelledby`
2. Locked step bodies have `inert` attribute — `querySelectorAll('.cfg-step__body[inert]')` matches locked steps
3. `_preloadImage` method exists and is called before image transitions
4. `_cacheEls` stores commonly-accessed DOM nodes
5. Qty buttons have `aria-label` attributes
6. `.cfg-qty-btn` is at least 44x44px
7. `.cfg-tooltip-btn` hit area is at least 44x44px
8. Tab key skips locked step interactive content
9. After step unlock, focus moves to the new step
</verification>

<success_criteria>
- No visible image flash when navigating between configurator steps
- Keyboard-only user can complete all 15 steps using Tab, Enter/Space, and arrow keys
- Screen reader announces step names, option labels, selection state, and price updates
- All touch targets are minimum 44x44px on mobile
- Locked steps are fully inert (not focusable, not announced as interactive)
- DOM queries in hot paths use cached references
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-and-accessibility/03-03-SUMMARY.md`
</output>
