---
phase: 03-performance-and-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - layout/theme.liquid
  - assets/theme.js
  - assets/theme.css
  - config/settings_schema.json
autonomous: true
requirements:
  - PERF-02
  - PERF-03
  - A11Y-05

must_haves:
  truths:
    - "GSAP loads from a pinned CDN URL (3.13.0) and will not silently change versions"
    - "If GSAP CDN fails to load, scroll animations degrade gracefully with no JS errors"
    - "All normal-size body text meets WCAG 2.1 AA contrast ratio (4.5:1 minimum) against its background"
  artifacts:
    - path: "layout/theme.liquid"
      provides: "Pinned GSAP CDN URLs"
      contains: "gsap@3.13.0"
    - path: "assets/theme.js"
      provides: "GSAP guard for both gsap and ScrollTrigger"
      contains: "typeof ScrollTrigger"
    - path: "assets/theme.css"
      provides: "Updated muted text color that passes AA contrast"
      contains: "--color-text-muted"
  key_links:
    - from: "layout/theme.liquid"
      to: "assets/theme.js"
      via: "deferred script loading — theme.js expects gsap global from CDN"
      pattern: "gsap@3\\.13\\.0"
    - from: "assets/theme.css"
      to: "config/settings_schema.json"
      via: "CSS variable default must match schema default for muted text color"
      pattern: "color-text-muted"
---

<objective>
Pin GSAP to a specific CDN version, verify the GSAP existence guard in theme.js, and fix the color contrast failure for muted text to meet WCAG 2.1 AA.

Purpose: Eliminate floating CDN version risk for animations and fix the most impactful accessibility color contrast violation affecting all pages.
Output: Updated theme.liquid with pinned GSAP URLs, verified theme.js guard, and compliant muted text color across CSS and settings schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-performance-and-accessibility/3-RESEARCH.md
@layout/theme.liquid
@assets/theme.js
@assets/theme.css
@config/settings_schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pin GSAP CDN version and verify existence guard</name>
  <files>layout/theme.liquid, assets/theme.js</files>
  <action>
In `layout/theme.liquid`, find the two GSAP `<script>` tags (approximately lines 63-64) that reference `gsap@3` and change them to `gsap@3.13.0`:
- `https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js` becomes `https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js`
- `https://cdn.jsdelivr.net/npm/gsap@3/dist/ScrollTrigger.min.js` becomes `https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js`

In `assets/theme.js`, verify the GSAP guard:
1. Confirm `initGSAPAnimations()` has an early return checking both `typeof gsap === 'undefined'` AND `typeof ScrollTrigger === 'undefined'` (research says this exists at ~line 501).
2. Confirm the calling code at ~lines 613-618 checks `typeof gsap !== 'undefined'` before calling, with a `window.addEventListener('load', initGSAPAnimations)` fallback.
3. If the ScrollTrigger check is missing from the inner guard, add it: `if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') return;`
4. No other changes to theme.js needed for this task — the guard is already sound per research.
  </action>
  <verify>
Grep layout/theme.liquid for "gsap@3.13.0" — should find exactly 2 matches.
Grep layout/theme.liquid for "gsap@3/" — should find 0 matches (no floating version remaining).
Grep assets/theme.js for "typeof gsap" — should find the guard pattern.
Grep assets/theme.js for "typeof ScrollTrigger" — should find the inner guard.
  </verify>
  <done>GSAP loads from pinned 3.13.0 URLs. The theme.js guard checks both gsap and ScrollTrigger before initializing animations, with a load event fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Fix muted text color contrast to meet WCAG AA</name>
  <files>assets/theme.css, config/settings_schema.json</files>
  <action>
The current `--color-text-muted` value is `#7D7B78` which achieves only ~3.8:1 contrast on the page background (#F4F1EC) — below the 4.5:1 WCAG AA requirement for normal text.

1. In `config/settings_schema.json`, find the color setting for "Text muted" (or equivalent label for the muted text color). Change its `default` value from `#7D7B78` to `#6A6864`. This darker value achieves approximately 4.5:1 contrast on #F4F1EC.

2. In `assets/theme.css`, search for any hardcoded instances of `#7D7B78` and replace with `var(--color-text-muted)` if they exist (they should already use the variable, but verify).

3. In `config/settings_data.json`, if the muted color is stored there (it may be the "current" settings), update `#7D7B78` to `#6A6864` as well so the live theme picks up the change immediately.

4. Verify that `--color-accent-dark: #3A8F7D` (used in configurator CSS for price text) has sufficient contrast on white — research estimates ~4.7:1 which passes AA. If it fails, note it but do not change it (it's in the configurator section stylesheet, handled in Plan 03's scope).

Do NOT change `--color-secondary` (#B6754D) or `--color-accent` (#C85E3F) — these are used for large text/UI components where 3:1 suffices.
  </action>
  <verify>
Grep config/settings_schema.json for the muted color default — should be `#6A6864` (or the decided replacement).
Grep assets/theme.css for `#7D7B78` — should find 0 hardcoded instances.
  </verify>
  <done>The muted text color meets WCAG 2.1 AA contrast ratio (4.5:1 minimum) against both the page background (#F4F1EC) and surface color (#EDE7DD). The settings schema default is updated so new theme installations use the compliant color.</done>
</task>

</tasks>

<verification>
1. `grep -c "gsap@3.13.0" layout/theme.liquid` returns 2
2. `grep -c "gsap@3/" layout/theme.liquid` returns 0
3. `grep "typeof gsap" assets/theme.js` shows guard pattern
4. `grep "typeof ScrollTrigger" assets/theme.js` shows inner guard
5. `grep "#7D7B78" assets/theme.css` returns nothing (no hardcoded failing color)
6. The settings schema default for muted text is a value achieving >= 4.5:1 contrast on #F4F1EC
</verification>

<success_criteria>
- GSAP loads from pinned 3.13.0 CDN URLs (no floating @3 tag)
- GSAP guard in theme.js checks both gsap and ScrollTrigger before running animations
- Muted text color achieves WCAG AA 4.5:1 contrast ratio on all background surfaces
- No regressions to existing scroll animations or text readability
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-and-accessibility/03-01-SUMMARY.md`
</output>
