---
phase: 03-performance-and-accessibility
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/configurator.js
autonomous: true
gap_closure: true
requirements:
  - PERF-01
  - PERF-04
  - A11Y-02

must_haves:
  truths:
    - "_preloadImage(url) fires before every _setMainImage() call, warming browser cache so step transitions show no flash"
    - "_cacheEls() stores a _stepEls map of all 15 step DOM elements plus _ovenNote, _sizeSection, _sizeCardsContainer"
    - "_unlockThrough() uses _stepEls map instead of querySelector loop, manages inert on .cfg-step__body, sets aria-disabled, and moves focus to first focusable element in newly unlocked step"
    - "Arrow keys (Left/Right/Up/Down) navigate between options within radio-style option groups"
    - "Qty buttons have aria-label attributes for screen reader identification"
  artifacts:
    - path: "assets/configurator.js"
      provides: "Image preloading, expanded DOM caching, keyboard navigation, ARIA management"
      contains: "_preloadImage"
  key_links:
    - from: "assets/configurator.js _preloadImage()"
      to: "assets/configurator.js _setMainImage()"
      via: "Every call site that invokes _setMainImage also fires _preloadImage beforehand"
      pattern: "_preloadImage"
    - from: "assets/configurator.js _unlockThrough()"
      to: "sections/configurator.liquid .cfg-step__body"
      via: "_unlockThrough toggles inert attribute on .cfg-step__body elements"
      pattern: "inert"
---

<objective>
Close 3 verification gaps in configurator.js: add image preloading, expand DOM caching, and implement keyboard navigation with ARIA management.

Purpose: The verification report found _preloadImage is absent, _cacheEls is unchanged from original 10 nodes, and keyboard navigation (arrow keys, inert, focus management) was never applied. These are the JS-side gaps blocking PERF-01, PERF-04, and A11Y-02.
Output: Updated assets/configurator.js with all three gap closures.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-performance-and-accessibility/3-RESEARCH.md
@.planning/phases/03-performance-and-accessibility/03-VERIFICATION.md
@assets/configurator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _preloadImage method and expand _cacheEls with step element map</name>
  <files>assets/configurator.js</files>
  <action>
**PERF-01 — Image preloading:**

Add a `_preloadImage(url)` method to the HotTubConfigurator class. Place it in the UI UTILITIES section (near _setMainImage around line 1281). Implementation:

```javascript
_preloadImage(url) {
  return new Promise((resolve) => {
    if (!url) { resolve(); return; }
    const img = new Image();
    img.onload = resolve;
    img.onerror = resolve; // resolve on error too — don't block UI
    img.src = url;
  });
}
```

This is fire-and-forget — caller does NOT await it. It warms the browser cache during the 120ms fade in _setMainImage.

Find every call site that invokes `_setMainImage(url)` and add a `this._preloadImage(url)` call immediately before it. Current call sites (from grep):
- Line ~531: `this._setMainImage(tier.image)` in model/tier selection — add `this._preloadImage(tier.image);` before it
- Line ~767: `if (product.image) this._setMainImage(product.image)` in product select — add `if (product.image) this._preloadImage(product.image);` before it
- Line ~1301: `if (images[0]) this._setMainImage(images[0].src)` in gallery — add `if (images[0]) this._preloadImage(images[0].src);` before it
- Line ~1308: `if (images[idx]) this._setMainImage(images[idx].src)` in gallery thumb — add `if (images[idx]) this._preloadImage(images[idx].src);` before it

**PERF-04 — DOM caching expansion:**

In `_cacheEls()` (line 82), after the existing 10 cached nodes, add:

1. A `_stepEls` map keyed by step number:
```javascript
this._stepEls = {};
for (let i = 1; i <= 15; i++) {
  const el = this.querySelector(`[data-step="${i}"]`);
  if (el) this._stepEls[i] = el;
}
```

2. Cache additional hot-path nodes:
```javascript
this._ovenNote = this.querySelector('[data-oven-note]');
this._sizeSection = this.querySelector('[data-size-section]');
this._sizeCardsContainer = this.querySelector('[data-size-cards]');
```

(If `data-oven-note`, `data-size-section`, or `data-size-cards` selectors don't exist, find the actual selectors used for these elements by grepping the querySelector calls in _updateOvenAvailability, _renderSizeCards, and _handleSizeSelect methods. Cache whatever selectors those methods use.)

Then update `_unlockThrough()` (line 1312) to use the `_stepEls` map instead of querying inside the loop:
```javascript
_unlockThrough(stepNum) {
  if (stepNum <= this.maxUnlocked) return;
  this.maxUnlocked = stepNum;
  for (let i = 1; i <= STEPS.length; i++) {
    const el = this._stepEls[i];
    if (!el) continue;
    el.classList.toggle('cfg-step--locked', i > this.maxUnlocked);
  }
  if (this.state.size && this.ctaBtn) {
    this.ctaBtn.disabled = false;
    this.ctaBtn.textContent = 'Add to Cart';
  }
}
```

Also update `_scrollToStep()` (line 1326) to use the map:
```javascript
_scrollToStep(num) {
  const el = this._stepEls[num];
  if (!el) return;
  setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 150);
}
```
  </action>
  <verify>
Grep configurator.js for `_preloadImage` — should find the method definition and at least 4 call sites.
Grep configurator.js for `_stepEls` — should find it in _cacheEls, _unlockThrough, and _scrollToStep.
Grep _unlockThrough for `this.querySelector` — should find zero (replaced with _stepEls).
  </verify>
  <done>_preloadImage fires before every _setMainImage call. _cacheEls stores _stepEls map plus additional hot-path nodes. _unlockThrough and _scrollToStep use cached references instead of querySelectorAll.</done>
</task>

<task type="auto">
  <name>Task 2: Add ARIA management, inert toggling, focus movement, arrow key navigation, and qty aria-labels</name>
  <files>assets/configurator.js</files>
  <action>
**A11Y-02 — Keyboard navigation and ARIA management in JS:**

1. **Update _unlockThrough()** to manage ARIA and inert. After the classList.toggle line inside the loop, add:
```javascript
el.setAttribute('aria-disabled', String(i > this.maxUnlocked));
const body = el.querySelector('.cfg-step__body');
if (body) {
  if (i > this.maxUnlocked) {
    body.setAttribute('inert', '');
  } else {
    body.removeAttribute('inert');
  }
}
```

After the loop, add focus management to the newly unlocked step:
```javascript
const newStep = this._stepEls[stepNum];
if (newStep) {
  setTimeout(() => {
    const firstFocusable = newStep.querySelector('button, [tabindex="0"], input, [data-action]');
    if (firstFocusable) firstFocusable.focus();
  }, 200);
}
```

2. **Add arrow key navigation** to the existing keydown handler (line 491). Currently it exits on any key that is not Enter or Space. Modify the handler to ALSO handle ArrowLeft, ArrowRight, ArrowUp, ArrowDown:

```javascript
this.addEventListener('keydown', (e) => {
  if (['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown'].includes(e.key)) {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    const group = target.closest('.cfg-option-group, .cfg-model-cards, .cfg-size-cards, .cfg-product-list, .cfg-swatch-group, .cfg-pill-group, .cfg-radio-group');
    if (!group) return;
    const items = [...group.querySelectorAll('[data-action]')];
    const idx = items.indexOf(target);
    if (idx === -1) return;
    e.preventDefault();
    const next = (e.key === 'ArrowRight' || e.key === 'ArrowDown')
      ? items[(idx + 1) % items.length]
      : items[(idx - 1 + items.length) % items.length];
    next.focus();
    return;
  }
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const target = e.target.closest('[data-action]');
  if (!target) return;
  e.preventDefault();
  target.click();
});
```

Find the exact container class names by checking how option groups are rendered in the JS (model cards, size cards, product lists, swatches, pills). The selector list in the `closest()` call should match whatever wrapper classes exist. Check the innerHTML assignments in _renderModelSizeStep, _renderCollectionStep, _renderSwatchStep, _renderCheckboxStep for the wrapper class names, and use those.

3. **Add aria-label to qty buttons.** Find the two innerHTML templates that generate qty buttons (lines ~196 and ~282). Add `aria-label="Decrease quantity"` to the minus button and `aria-label="Increase quantity"` to the plus button:

Line ~196:
```javascript
<button type="button" class="cfg-qty-btn" data-action="qty-minus" data-group="${dataKey}" aria-label="Decrease quantity">−</button>
...
<button type="button" class="cfg-qty-btn" data-action="qty-plus" data-group="${dataKey}" aria-label="Increase quantity">+</button>
```

Line ~282 (pillow qty):
```javascript
<button type="button" class="cfg-qty-btn" data-action="qty-minus" data-group="${stateKey}" aria-label="Decrease quantity">−</button>
...
<button type="button" class="cfg-qty-btn" data-action="qty-plus" data-group="${stateKey}" aria-label="Increase quantity">+</button>
```

4. **Set initial inert on locked steps during connectedCallback.** After `_renderSteps()` completes (line 78), add a loop that sets inert on all locked step bodies:
```javascript
// Set inert on locked step bodies after initial render
for (let i = 2; i <= STEPS.length; i++) {
  const el = this._stepEls[i];
  if (!el) continue;
  const body = el.querySelector('.cfg-step__body');
  if (body) body.setAttribute('inert', '');
}
```

This ensures keyboard cannot reach locked content on initial page load (before any interaction triggers _unlockThrough).
  </action>
  <verify>
Grep configurator.js for `aria-disabled` — should appear in _unlockThrough.
Grep configurator.js for `inert` — should appear in _unlockThrough and connectedCallback initialization.
Grep configurator.js for `.focus()` — should appear after unlock logic.
Grep configurator.js for `ArrowLeft` — should appear in keydown handler.
Grep configurator.js for `aria-label="Decrease quantity"` — should appear in 2 qty button templates.
Grep configurator.js for `aria-label="Increase quantity"` — should appear in 2 qty button templates.
  </verify>
  <done>_unlockThrough manages aria-disabled and inert on step bodies and moves focus to newly unlocked step. Arrow keys navigate within option groups. Qty buttons have descriptive aria-labels. Locked steps are inert on initial render.</done>
</task>

</tasks>

<verification>
1. `grep -c '_preloadImage' assets/configurator.js` returns >= 5 (1 definition + 4+ call sites)
2. `grep -c '_stepEls' assets/configurator.js` returns >= 4 (_cacheEls, _unlockThrough, _scrollToStep, connectedCallback init)
3. `grep 'aria-disabled' assets/configurator.js` shows management in _unlockThrough
4. `grep 'ArrowLeft' assets/configurator.js` shows arrow key handler
5. `grep 'aria-label="Decrease quantity"' assets/configurator.js` returns 2 matches
6. `grep 'inert' assets/configurator.js` shows both initialization and _unlockThrough management
7. `grep -c 'this\.querySelector.*data-step' assets/configurator.js` returns 0 in _unlockThrough and _scrollToStep (replaced by _stepEls)
</verification>

<success_criteria>
- _preloadImage() exists and fires before every _setMainImage() call
- _cacheEls() includes _stepEls map and additional hot-path nodes
- _unlockThrough() uses cached _stepEls, manages aria-disabled and inert, moves focus
- Arrow key navigation works within option groups
- Qty buttons have aria-label for screen readers
- Locked step bodies are inert on initial page load
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-and-accessibility/03-04-SUMMARY.md`
</output>
