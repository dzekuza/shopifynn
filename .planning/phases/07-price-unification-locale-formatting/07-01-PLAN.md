---
phase: 07-price-unification-locale-formatting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/configurator.js
autonomous: true
requirements:
  - CONF-07
  - CONF-08

must_haves:
  truths:
    - "money() formats currency using the shop's locale and currency from window.__shopLocale/window.__shopCurrency — not hardcoded de-DE/EUR"
    - "Selecting a product multiple times in the same step does not accumulate duplicate event listeners"
    - "Gallery thumbnail clicks after model switch show the correct model's images"
    - "All dynamic child interactions route through the single delegated click handler in _bindEvents()"
  artifacts:
    - path: "assets/configurator.js"
      provides: "Locale-aware money() and fully delegated event handling"
      contains: "Intl.NumberFormat"
  key_links:
    - from: "money()"
      to: "window.__shopLocale, window.__shopCurrency"
      via: "Intl.NumberFormat constructor"
      pattern: "Intl\\.NumberFormat\\(.*__shopLocale"
    - from: "_bindEvents() switch"
      to: "select-variant, select-thumb, edit-summary-step"
      via: "data-action delegation cases"
      pattern: "case 'select-variant'"
---

<objective>
Fix locale-aware currency formatting and eliminate accumulating per-element event listeners in configurator.js.

Purpose: CONF-08 — money() hardcodes 'de-DE' locale and '€' symbol, ignoring the shop's actual locale/currency injected in theme.liquid. CONF-07 — _showVariants() and _updateGallery() attach new listeners on every re-render, accumulating duplicates that cause multiple handler firings and wasted DOM updates.

Output: configurator.js with Intl.NumberFormat-based money() and all dynamic interactions routed through _bindEvents() delegation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-price-unification-locale-formatting/07-RESEARCH.md
@assets/configurator.js
@layout/theme.liquid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite money() to use Intl.NumberFormat with shop locale/currency globals</name>
  <files>assets/configurator.js</files>
  <action>
Replace the money() function (lines 14-17) with an Intl.NumberFormat-based implementation:

BEFORE:
```javascript
function money(cents) {
  const val = (cents / 100).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  return '€' + val;
}
```

AFTER:
```javascript
function money(cents) {
  const locale = window.__shopLocale || 'de-DE';
  const currency = window.__shopCurrency || 'EUR';
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: currency,
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(cents / 100);
}
```

Key details:
- window.__shopLocale and window.__shopCurrency are already injected in layout/theme.liquid (after footer section, before closing body tag). configurator.js loads with defer, so these globals are guaranteed to exist at execution time.
- Fallbacks 'de-DE' and 'EUR' protect against edge cases (Theme Editor preview, shopify theme dev) where injection order may vary.
- Intl.NumberFormat with style:'currency' handles symbol placement automatically (€100 vs 100 € vs $100) for all locales — no manual symbol prefix needed.
- Function signature and return type are unchanged (string) — all call sites work as-is.
- Do NOT cache the formatter as a module-level constant — money() is called at most ~15 times per _updatePrice() cycle, instantiation cost is negligible, and caching would miss runtime locale changes.
  </action>
  <verify>
Search configurator.js for any remaining hardcoded 'de-DE' or '€' — must find zero matches. Verify Intl.NumberFormat is used in money(). Verify window.__shopLocale and window.__shopCurrency appear in money().
  </verify>
  <done>money() uses Intl.NumberFormat with window.__shopLocale and window.__shopCurrency, with de-DE/EUR fallbacks. No hardcoded locale or currency symbol in the function.</done>
</task>

<task type="auto">
  <name>Task 2: Replace per-element listeners with delegation in _bindEvents()</name>
  <files>assets/configurator.js</files>
  <action>
Four per-element listeners must be replaced with delegated handling. Make these changes in order:

**A. Add select-variant case to _bindEvents() switch (around line 541, before closing of switch):**

```javascript
case 'select-variant': {
  const group = target.dataset.group;
  const variantArea = target.closest('[data-variant-area]');
  if (variantArea) {
    variantArea.querySelectorAll('.cfg-swatch--selected, .cfg-pill--selected').forEach(s => {
      s.classList.remove('cfg-swatch--selected', 'cfg-pill--selected');
      s.setAttribute('aria-pressed', 'false');
    });
  }
  const selectedClass = target.classList.contains('cfg-swatch') ? 'cfg-swatch--selected' : 'cfg-pill--selected';
  target.classList.add(selectedClass);
  target.setAttribute('aria-pressed', 'true');
  this._selectVariant(group, parseInt(target.dataset.variantId), parseInt(target.dataset.price));
  break;
}
```

This replaces the logic from the per-element listener at line 432-442. The variant items already have `data-action="select-variant"` with `data-group`, `data-variant-id`, `data-price` attributes. The parent `[data-variant-area]` container is used to scope class removal (same as the old `target` variable in _showVariants). `target.closest('[data-variant-area]')` walks up from the clicked swatch/pill to find the area — this works because data-variant-area wraps both swatch and pill containers.

**B. Add select-thumb case to _bindEvents() switch:**

```javascript
case 'select-thumb': {
  const idx = parseInt(target.dataset.thumbIdx);
  this.gallery.querySelectorAll('.cfg-thumb').forEach((t, i) =>
    t.classList.toggle('cfg-thumb--active', i === idx)
  );
  const img = this._galleryImages?.[idx];
  if (img) {
    this._preloadImage(img.src);
    this._setMainImage(img.src);
  }
  break;
}
```

**C. Add edit-summary-step case to _bindEvents() switch:**

```javascript
case 'edit-summary-step': {
  const stepNum = parseInt(target.dataset.editStep, 10);
  this._scrollToStep(stepNum);
  break;
}
```

**D. Remove the per-element listener from _showVariants() (lines 432-442):**

Delete the entire `target.addEventListener('click', ...)` block. The _showVariants() method should end after `this._selectVariant(group, variants[0]?.id, variants[0]?.price);` (line 430).

**E. Modify _updateGallery() (lines 1587-1605):**

1. Add `this._galleryImages = images;` at the start of the method (after the guard check on line 1588). This stores the images array on the instance for the delegated handler to access.

2. Add `data-action="select-thumb"` to each thumb div in the innerHTML template. Change:
```
<div class="cfg-thumb ${i === 0 ? 'cfg-thumb--active' : ''}" data-thumb-idx="${i}"
```
to:
```
<div class="cfg-thumb ${i === 0 ? 'cfg-thumb--active' : ''}" data-action="select-thumb" data-thumb-idx="${i}"
```

3. Delete the entire `this.gallery.addEventListener('click', ...)` block (lines 1597-1604).

**F. Modify summary card in _updateSummary() (line 1243):**

1. Change `data-edit-step` on edit buttons to use `data-action="edit-summary-step"` data-edit-step="${stepNum}". The edit buttons are built earlier in _updateSummary — find where they are created and ensure they have `data-action="edit-summary-step"`.

2. Delete the per-element `card.addEventListener('click', ...)` block (lines 1243-1248).

**G. Remove the direct ctaBtn listener (line 577):**

Delete `this.ctaBtn?.addEventListener('click', () => this._handleAddToCart());`. The main CTA button should already have a `data-action` attribute. Check the Liquid template for the CTA button — if it has `data-action="add-to-cart"` or similar, add a matching case to the switch. If it does not have a data-action, add `data-action="add-to-cart"` to the button in the Liquid template (sections/configurator.liquid) and add:

```javascript
case 'add-to-cart':
  this._handleAddToCart();
  break;
```

Note: `sticky-add-to-cart` case already exists at line 539. The ctaBtn may be a different button (the main CTA vs the sticky one). Check which element `this.ctaBtn` points to in _cacheEls() to determine the correct approach.

**Key anti-pattern reminder:** NEVER add addEventListener inside a method that is called on user interaction. Only _bindEvents() (called once in connectedCallback) may wire events.
  </action>
  <verify>
1. Search configurator.js for `addEventListener` — the only remaining calls should be: (a) `this.addEventListener('click'` in _bindEvents, (b) `this.addEventListener('keydown'` in _bindEvents, (c) `document.addEventListener('DOMContentLoaded'` at the bottom, (d) the `toast.addEventListener('transitionend'` in _showToast (which is fine — it uses `{ once: true }` so it self-cleans).
2. Verify `case 'select-variant':` exists in the switch block.
3. Verify `case 'select-thumb':` exists in the switch block.
4. Verify `data-action="select-thumb"` appears in _updateGallery's innerHTML template.
5. Verify `this._galleryImages = images` exists near the top of _updateGallery().
6. Verify no `target.addEventListener` exists in _showVariants().
7. Verify no `this.gallery.addEventListener` exists in _updateGallery().
  </verify>
  <done>All dynamic child interactions route through _bindEvents() delegated click handler. No per-element listeners accumulate on re-renders. Gallery images stored as this._galleryImages for delegated access. Summary card edit buttons use data-action delegation. CTA button uses delegation.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `money()` — grep for hardcoded 'de-DE' and '€' in configurator.js: zero matches expected (except possibly in Intl.NumberFormat fallback which is acceptable).
2. Event delegation — grep for `addEventListener` in configurator.js: only 3-4 legitimate calls remain (two in _bindEvents for click/keydown, one DOMContentLoaded, one toast transitionend with {once:true}).
3. No `_calculateLineItems()` function should exist — that belongs to Phase 6 (CONF-04), not this phase.
4. All existing switch cases in _bindEvents() remain intact — new cases are additive.
</verification>

<success_criteria>
- money() produces locale-correct formatting using shop globals with de-DE/EUR fallbacks
- Zero per-element listeners accumulate across re-renders (variant selection, gallery rebuild, summary rebuild)
- All interactive elements in dynamically-rendered content use data-action attributes and route through _bindEvents()
- No functional regression — all 15 configurator steps still work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-price-unification-locale-formatting/07-01-SUMMARY.md`
</output>
