---
phase: 05-xss-sanitization-recovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sections/configurator.liquid
  - assets/configurator.js
autonomous: true
requirements:
  - SEC-04
  - SEC-05
  - SEC-06

must_haves:
  truths:
    - "DOMPurify 3.2.7 loads on the configurator page before configurator.js executes"
    - "All innerHTML call sites that interpolate product data are wrapped in DOMPurify.sanitize()"
    - "Static innerHTML assignments (empty strings, hardcoded HTML) are left untouched"
    - "_escAttr() method does not exist in configurator.js — zero definitions, zero references"
    - "The configurator renders all 15 steps correctly after sanitization is applied"
  artifacts:
    - path: "sections/configurator.liquid"
      provides: "DOMPurify CDN script tag before configurator.js"
      contains: "dompurify@3.2.7"
    - path: "assets/configurator.js"
      provides: "Sanitized innerHTML call sites and no _escAttr method"
      contains: "DOMPurify.sanitize"
  key_links:
    - from: "sections/configurator.liquid"
      to: "assets/configurator.js"
      via: "defer script loading order — DOMPurify before configurator.js"
      pattern: "dompurify.*defer.*configurator\\.js.*defer"
    - from: "assets/configurator.js"
      to: "window.DOMPurify"
      via: "DOMPurify.sanitize() calls in rendering methods"
      pattern: "DOMPurify\\.sanitize"
---

<objective>
Eliminate all XSS vectors in configurator.js by loading DOMPurify on the configurator template, sanitizing all dynamic innerHTML call sites, and deleting the insecure _escAttr() helper.

Purpose: This is gap closure — Phase 1 XSS work was overwritten during subsequent phases. The configurator interpolates product data (titles, prices, images, tooltip text from Shopify metafields) directly into innerHTML templates. While this data is admin-entered, defense-in-depth sanitization prevents stored XSS if a metafield value is ever compromised.

Output: configurator.liquid with DOMPurify CDN script tag, configurator.js with all dynamic innerHTML sites sanitized and _escAttr() deleted.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-xss-sanitization-recovery/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DOMPurify CDN script and guard in configurator template</name>
  <files>sections/configurator.liquid</files>
  <action>
Add a DOMPurify 3.2.7 script tag from jsDelivr CDN immediately BEFORE the existing configurator.js script tag (line 560). Both must use `defer` so they execute in document order.

Insert this line before `<script src="{{ 'configurator.js' | asset_url }}" defer></script>`:

```html
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.7/dist/purify.min.js" defer></script>
```

Pin to exact semver 3.2.7 — consistent with Phase 3 GSAP pinning convention.

CDN failure guard: In `assets/configurator.js`, at the very top of `connectedCallback()` (after the existing `querySelector('[data-configurator-products]')` guard), add a DOMPurify availability check:

```javascript
if (typeof DOMPurify === 'undefined') {
  console.error('[Configurator] DOMPurify failed to load — XSS sanitization unavailable.');
  return;
}
```

This mirrors the GSAP guard pattern from Phase 3 — fail visibly rather than silently skip sanitization. The configurator will not render if DOMPurify is unavailable.
  </action>
  <verify>
Grep for "dompurify@3.2.7" in sections/configurator.liquid — must find exactly one match.
Grep for "DOMPurify" in assets/configurator.js — must find the guard check.
Verify the DOMPurify script tag appears BEFORE the configurator.js script tag in the file.
  </verify>
  <done>DOMPurify 3.2.7 loads via jsDelivr CDN with defer before configurator.js. A guard in connectedCallback prevents rendering if the CDN fails.</done>
</task>

<task type="auto">
  <name>Task 2: Sanitize all dynamic innerHTML sites and delete _escAttr()</name>
  <files>assets/configurator.js</files>
  <action>
Apply DOMPurify.sanitize() to all dynamic innerHTML call sites and delete _escAttr(). Use default DOMPurify config (no ALLOWED_TAGS restriction).

**Sites to WRAP with DOMPurify.sanitize() (Category C — dynamic interpolation):**

For each of these, wrap the HTML string in `DOMPurify.sanitize(...)` before innerHTML assignment:

1. Line 178 (`_renderModelSizeStep`): `container.innerHTML = html;` → `container.innerHTML = DOMPurify.sanitize(html);`
2. Line 230 (`_renderCollectionStep`): `container.innerHTML = html;` → `container.innerHTML = DOMPurify.sanitize(html);`
3. Line 242 (`_renderCheckboxStep` inline template): Wrap the template literal in `DOMPurify.sanitize(...)`
4. Line 258 (`_renderCheckboxDropdownStep` inline template): Wrap the template literal in `DOMPurify.sanitize(...)`
5. Line 295 (`_renderCheckboxQtyStep` inline template): Wrap the template literal in `DOMPurify.sanitize(...)`
6. Line 352 (`_renderOvenStep`): `container.innerHTML = html;` → `container.innerHTML = DOMPurify.sanitize(html);`
7. Line 358 (`_renderDiagramStep` controls): Wrap the template literal in `DOMPurify.sanitize(...)`
8. Line 363 (`_renderDiagramStep` heater_conn): Wrap the template literal in `DOMPurify.sanitize(...)`
9. Line 390 (`_renderSizeCards`): Wrap the `sizes.map(...)` template in `DOMPurify.sanitize(...)`
10. Line 415 (`swatchContainer.innerHTML`): Wrap the `variants.map(...)` template in `DOMPurify.sanitize(...)`
11. Line 421 (`pillsContainer.innerHTML`): Wrap the `variants.map(...)` template in `DOMPurify.sanitize(...)`
12. Line 1589 (`_updateGallery`): Wrap the `images.map(...)` template in `DOMPurify.sanitize(...)`

**Sites to LEAVE AS-IS (Category A — static/clear):**
- Line 184: Static string `'<p class="cfg-empty">No options configured yet.</p>'` — no XSS risk
- Line 237: Static string `'<p class="cfg-empty">Not configured.</p>'` — no XSS risk
- Line 289: Static string `'<p class="cfg-empty">Not configured.</p>'` — no XSS risk
- Line 1254: Clear `''` — no XSS risk
- Line 1255: Clear `''` — no XSS risk
- Line 1512: Clear `''` — no XSS risk
- Line 1529: Clear `''` — no XSS risk

**Handle _escAttr() call sites (3 total) — use Option A from research:**

At all 3 sites (lines 204, 251, 345), remove the `this._escAttr()` wrapper from the tooltip interpolation. Change:
```javascript
data-tooltip="${this._escAttr(tooltip)}"
```
to:
```javascript
data-tooltip="${tooltip}"
```

DOMPurify.sanitize() wrapping the full HTML block (already applied above) will safely encode the data-tooltip attribute value. The _showTooltip() method reads it via `btn.dataset.tooltip` and renders with `textContent`, so the chain is secure.

**Delete _escAttr() method:**

Remove the entire `_escAttr(str)` method definition (starts at line 1628, 3 lines including closing brace).

**Verification grep after all changes:**
- `grep -n "_escAttr" assets/configurator.js` must return NO output
- `grep -c "DOMPurify.sanitize" assets/configurator.js` must return 12 (one per dynamic site)
  </action>
  <verify>
Run: `grep -n "_escAttr" assets/configurator.js` — must return empty (zero references).
Run: `grep -c "DOMPurify.sanitize" assets/configurator.js` — must return 12.
Run: `grep -n "innerHTML" assets/configurator.js` — verify all dynamic sites have DOMPurify.sanitize() and static sites are untouched.
Verify no syntax errors: the file should parse cleanly (check balanced braces, no stray backticks).
  </verify>
  <done>All 12 dynamic innerHTML sites wrapped in DOMPurify.sanitize(). All 3 _escAttr() references removed from tooltip templates. _escAttr() method definition deleted. 7 static/clear innerHTML sites left untouched. Zero _escAttr references remain in the codebase.</done>
</task>

</tasks>

<verification>
1. `grep -c "DOMPurify.sanitize" assets/configurator.js` returns 12
2. `grep -n "_escAttr" assets/configurator.js` returns empty
3. `grep "dompurify@3.2.7" sections/configurator.liquid` returns 1 match
4. DOMPurify script tag appears on the line immediately before configurator.js script tag
5. Static innerHTML sites (lines 184, 237, 289, 1254, 1255, 1512, 1529) remain unwrapped
6. The DOMPurify guard in connectedCallback logs an error and returns early if CDN fails
</verification>

<success_criteria>
- SEC-04: All 12 dynamic innerHTML call sites use DOMPurify.sanitize() — no raw interpolation into innerHTML
- SEC-05: DOMPurify 3.2.7 loads from jsDelivr CDN with defer before configurator.js on the configurator template
- SEC-06: _escAttr() method is completely removed — zero definitions and zero references in configurator.js
</success_criteria>

<output>
After completion, create `.planning/phases/05-xss-sanitization-recovery/05-01-SUMMARY.md`
</output>
