---
phase: 08-css-architecture-themejs-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sections/configurator.liquid
  - assets/configurator.css
  - assets/theme.js
autonomous: true
requirements:
  - ARCH-01
  - ARCH-02
  - ARCH-04

must_haves:
  truths:
    - "assets/configurator.css exists and contains all configurator styles (~18 KB)"
    - "configurator.liquid no longer has a {% stylesheet %} block — the {% style %} block remains"
    - "The configurator page loads configurator.css via the existing conditional in theme.liquid (no 404)"
    - "theme.js has zero var declarations — all replaced with const or let per reassignment semantics"
  artifacts:
    - path: "assets/configurator.css"
      provides: "All static configurator CSS extracted from section stylesheet block"
      contains: ".cfg"
    - path: "sections/configurator.liquid"
      provides: "Configurator section without {% stylesheet %} block, {% style %} block intact"
    - path: "assets/theme.js"
      provides: "Modernized variable declarations — const/let only"
  key_links:
    - from: "layout/theme.liquid"
      to: "assets/configurator.css"
      via: "{{ 'configurator.css' | asset_url | stylesheet_tag }} inside template.suffix == 'configurator' conditional"
      pattern: "configurator\\.css.*asset_url.*stylesheet_tag"
---

<objective>
Extract configurator CSS to a dedicated cacheable asset file and modernize theme.js variable declarations.

Purpose: Close the two remaining architectural gaps — configurator CSS lives inline in a {% stylesheet %} block (not cacheable, causing a 404 since the conditional loader already exists), and theme.js still has 24 var declarations from a partial earlier migration.

Output: `assets/configurator.css` (new file), updated `sections/configurator.liquid` (stylesheet block removed), updated `assets/theme.js` (var→const/let).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-css-architecture-themejs-cleanup/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract configurator CSS to assets/configurator.css</name>
  <files>sections/configurator.liquid, assets/configurator.css</files>
  <action>
1. Read `sections/configurator.liquid` and locate the `{% stylesheet %}` block (lines 11–258 per research).
2. Copy the CSS content between `{% stylesheet %}` and `{% endstylesheet %}` (the pure CSS, not the Liquid tag lines themselves) to a new file `assets/configurator.css`.
3. Delete the entire `{% stylesheet %}` through `{% endstylesheet %}` block from `sections/configurator.liquid`.
4. Verify the `{% style %}` block (lines ~260–263, using `{{ section.settings.background_color }}` and padding settings) is UNTOUCHED — do NOT delete it.
5. Verify zero `{{` or `{%` Liquid expressions exist in the extracted `assets/configurator.css` — it must be pure CSS.

No changes to `layout/theme.liquid` — the conditional loader (`{% if template.suffix == 'configurator' %}{{ 'configurator.css' | asset_url | stylesheet_tag }}{% endif %}`) already exists on lines 51–53 and will resolve once the asset file is created.
  </action>
  <verify>
- `grep -c "stylesheet" sections/configurator.liquid` returns 0 (no {% stylesheet %} block)
- `grep -c "{% style %}" sections/configurator.liquid` returns 1 (dynamic style block preserved)
- `wc -c assets/configurator.css` shows ~18000+ bytes (non-trivial file)
- `grep -c "{{" assets/configurator.css` returns 0 (no Liquid expressions)
- `grep -c "{%" assets/configurator.css` returns 0 (no Liquid tags)
  </verify>
  <done>assets/configurator.css exists with all configurator styles, the {% stylesheet %} block is removed from configurator.liquid, and the {% style %} block remains intact</done>
</task>

<task type="auto">
  <name>Task 2: Replace all var declarations with const/let in theme.js</name>
  <files>assets/theme.js</files>
  <action>
Replace all 24 `var` declarations in `assets/theme.js` with the correct modern keyword. The file has `'use strict';` on line 6 — using `const` on a reassigned binding will throw a TypeError at runtime.

Use the following replacement table from research (verify line numbers against actual file):

**Use `let` (4 bindings — these are reassigned after declaration):**
- `var touchStartX = 0;` → `let touchStartX = 0;` (reassigned in touchstart listener)
- `var productVariants = [];` → `let productVariants = [];` (reassigned: `productVariants = JSON.parse(...)`)
- `for (var i = 0; ...)` → `for (let i = 0; ...)` (loop counter)
- `var hiddenSelect = swatch.closest(...)` → `let hiddenSelect = swatch.closest(...)` (reassigned on next line via chained querySelector — confirmed in STATE.md decision from Phase 01)

**Use `const` (19 bindings — never reassigned):**
All remaining `var` declarations: `track`, `diff`, `productJsonEl`, `addToCartBtn`, `options`, `selectedOptions`, `matchedVariant`, `variantInput`, `priceEl`, `compareEl`, `saveBadge`, `saved`, `btn`, `url`, `galleryImages`, `filename`, `value`, `group`, `optionWrap`, `valueLabel`.

**Process:** Do a single pass through the file. For each `var` keyword, check whether the binding is reassigned anywhere in its scope. If yes → `let`. If no → `const`. The research table covers all 24 occurrences but verify against the actual current file state in case line numbers shifted.

**Critical pitfalls to avoid:**
- Do NOT use `const` for `touchStartX` (reassigned in listener callback)
- Do NOT use `const` for `productVariants` (reassigned via JSON.parse)
- Do NOT use `const` for loop counter `i` (incremented each iteration)
- Do NOT use `const` for `hiddenSelect` (reassigned via querySelector chain)
  </action>
  <verify>
- `grep -c "\bvar\b" assets/theme.js` returns 0 (zero var declarations remain)
- `grep -c "\bconst\b\|\blet\b" assets/theme.js` shows the file uses modern declarations throughout
- No syntax errors: the file should have valid JavaScript (no unterminated statements or mismatched braces)
  </verify>
  <done>theme.js contains zero var declarations — all 24 occurrences replaced with const (19) or let (4) based on reassignment semantics</done>
</task>

</tasks>

<verification>
1. `grep -c "stylesheet" sections/configurator.liquid` → 0
2. `grep -c "{% style %}" sections/configurator.liquid` → 1
3. `wc -c assets/configurator.css` → ~18000+ bytes
4. `grep -c "\bvar\b" assets/theme.js` → 0
5. `grep -c "{{" assets/configurator.css` → 0 (no Liquid in CSS)
6. `grep -c "{%" assets/configurator.css` → 0 (no Liquid in CSS)
</verification>

<success_criteria>
- assets/configurator.css exists with all static configurator styles extracted verbatim
- sections/configurator.liquid has no {% stylesheet %} block; {% style %} block untouched
- layout/theme.liquid conditional loads the new asset file (no changes needed — already in place)
- assets/theme.js has zero var declarations; all replaced with const or let correctly
- No Liquid expressions in the extracted CSS file
</success_criteria>

<output>
After completion, create `.planning/phases/08-css-architecture-themejs-cleanup/08-01-SUMMARY.md`
</output>
